<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estate Shuttle Bus Schedule</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        :root {
            --pri: #3498db;
            --pri-light: rgba(52, 152, 219, 0.2);
            --sec: #2980b9;
            --acc: #e74c3c;
            --bg: #f5f7fa;
            --txt: #2c3e50;
            --txt-sec: #7f8c8d;
            --special: #e67e22;
            --card: white;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --next-border: 3px solid var(--pri);
            --special-bg: #fef0e6;
            --inp-bg: white;
            --inp-brd: #ddd;
            --tog-bg: #ecf0f1;
            --tog-txt: #333;
            --dt-bg: rgba(52, 152, 219, 0.1);
            --date-txt: #2c3e50;
            --time-txt: #3498db;
            --holiday: #e74c3c;
            --est-bg: #f5f7fa;
            --est-act: #3498db;
            --est-inact: #ecf0f1;
        }
        
        @media (prefers-color-scheme: dark) {
            :root {
                --pri: #2980b9;
                --pri-light: rgba(41, 128, 185, 0.2);
                --sec: #3498db;
                --acc: #e74c3c;
                --bg: #1a1a1a;
                --txt: #ecf0f1;
                --txt-sec: #bdc3c7;
                --special: #e67e22;
                --card: #2c2c2c;
                --shadow: 0 2px 10px rgba(0,0,0,0.3);
                --next-border: 3px solid var(--pri);
                --special-bg: #4a3319;
                --inp-bg: #2c2c2c;
                --inp-brd: #444;
                --tog-bg: #444;
                --tog-txt: #ecf0f1;
                --dt-bg: rgba(41, 128, 185, 0.2);
                --date-txt: #ecf0f1;
                --time-txt: #3498db;
                --holiday: #e74c3c;
                --est-bg: #2c2c2c;
                --est-act: #2980b9;
                --est-inact: #444;
            }
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        
        body {
            background-color: var(--bg);
            color: var(--txt);
            line-height: 1.6;
            padding: 15px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .est-tog {
            display: flex;
            margin: 15px auto;
            background-color: var(--est-bg);
            border-radius: 10px;
            padding: 5px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        
        .est-tog button {
            flex: 1;
            padding: 10px 15px;
            border: none;
            background-color: transparent;
            color: var(--txt);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
        }
        
        .est-tog button.active {
            background-color: var(--est-act);
            color: white;
        }
        
        .est-tog button:not(.active) {
            background-color: var(--est-inact);
        }
        
        .dt-cont {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            width: 100%;
            max-width: 500px;
        }
        
        .dt-card {
            background: var(--dt-bg);
            border-radius: 12px;
            padding: 10px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .date-display {
            font-size: 1rem;
            font-weight: 500;
            color: var(--date-txt);
            margin-bottom: 4px;
            width: 100%;
            text-align: center;
        }
        
        .time-cont {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            margin-bottom: 6px;
        }
        
        .time-unit {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .time-val {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--time-txt);
            text-align: center;
            min-width: 40px;
            line-height: 1.2;
        }
        
        .time-lab {
            font-size: 0.7rem;
            color: var(--txt-sec);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .time-sep {
            font-size: 1.8rem;
            color: var(--time-txt);
            opacity: 0.5;
            margin: 0 2px;
            line-height: 1.2;
        }
        
        .day-cont {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .day-disp {
            display: inline-block;
            padding: 3px 12px;
            margin-top: 5px;
            border-radius: 15px;
            font-weight: 600;
            background-color: var(--pri);
            color: white;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        
        .day-disp.weekend { background-color: var(--acc); }
        .day-disp.holiday { background-color: var(--special); }
        
        .holiday-name {
            font-size: 0.85rem;
            color: var(--holiday);
            font-weight: 600;
            margin-top: 3px;
        }
        
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .tab {
            padding: 10px 20px;
            background-color: var(--tog-bg);
            color: var(--tog-txt);
            border: none;
            cursor: pointer;
            margin: 3px;
            border-radius: 5px;
            font-weight: 600;
            transition: all 0.3s;
            flex: 1;
            text-align: center;
        }
        
        .tab.active {
            background-color: var(--pri);
            color: white;
        }
        
        .lang-tog {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .top-ctl {
            display: flex;
            justify-content: center;
            width: 100%;
            padding: 0 15px;
            margin-bottom: 15px;
        }
        
        .lang-tog button {
            padding: 5px 10px;
            background-color: var(--tog-bg);
            color: var(--tog-txt);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .lang-tog button.active {
            background-color: var(--pri);
            color: white;
        }
        
        .next-buses {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .next-bus-card {
            background-color: var(--card);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--shadow);
            flex: 1 1 300px;
            position: relative;
            overflow: hidden;
        }
        
        .next-bus-card h3 {
            color: var(--pri);
            margin-bottom: 12px;
            font-size: 1.2rem;
            border-bottom: 2px solid var(--bg);
            padding-bottom: 8px;
            font-weight: 600;
        }
        
        .time-disp {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--txt);
            margin: 12px 0;
            text-align: center;
        }
        
        .time-disp.special { color: var(--special); }
        
        .cdown {
            text-align: center;
            font-size: 1.1rem;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--txt-sec);
        }
        
        .cdown-bar-cont {
            position: relative;
            height: 8px;
            width: 100%;
            background-color: var(--bg);
            border-radius: 4px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        .cdown-bar {
            height: 100%;
            background: linear-gradient(to right, var(--pri), var(--sec));
            border-radius: 4px;
            width: 0%;
            transition: width 1s linear;
        }
        
        .spec-note {
            font-size: 0.9rem;
            color: var(--special);
            margin-top: 8px;
            font-style: italic;
            text-align: center;
        }
        
        .stops-note {
            font-size: 0.9rem;
            color: var(--txt-sec);
            margin-top: 2px;
            text-align: center;
        }
        
        .section-title {
            font-size: 1.3rem;
            color: var(--pri);
            margin: 20px 0 12px;
            text-align: center;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .section-title::before,
        .section-title::after {
            content: "";
            height: 1px;
            flex-grow: 1;
            background-color: var(--pri-light);
            margin: 0 15px;
        }
        
        .sched-cont {
            background-color: var(--card);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--shadow);
            margin-top: 15px;
            overflow-x: auto;
        }
        
        .sched-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .sched-title {
            font-size: 1.2rem;
            color: var(--pri);
            font-weight: 600;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        select, button, input {
            padding: 8px 12px;
            border: 1px solid var(--inp-brd);
            border-radius: 8px;
            background-color: var(--inp-bg);
            color: var(--txt);
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        input::placeholder { color: var(--txt-sec); opacity: 0.8; }
        
        button {
            background-color: var(--pri);
            color: white;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s;
            font-weight: 600;
        }
        
        button:hover { background-color: var(--sec); }
        
        .search-cont {
            display: flex;
            margin-bottom: 15px;
            width: 100%;
        }
        
        .search-inp {
            flex: 1;
            min-width: 0;
            margin-right: 10px;
        }
        
        .clear-search { background-color: var(--acc); }
        
        .time-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .time-cell {
            padding: 10px 8px;
            text-align: center;
            background-color: var(--bg);
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            transition: transform 0.2s;
            position: relative;
        }
        
        .time-cell:hover { transform: translateY(-2px); }
        
        .time-cell.special {
            background-color: var(--special-bg);
            color: var(--special);
            font-weight: 600;
        }
        
        .time-cell.highlight { animation: pulse 1s infinite alternate; }
        
        .time-cell.inter::after {
            content: "•";
            position: absolute;
            top: 3px;
            right: 5px;
            color: var(--txt-sec);
            font-size: 16px;
            font-weight: bold;
        }
        
        @keyframes pulse {
            from { opacity: 1; }
            to { opacity: 0.6; }
        }
        
        .time-cell.next {
            border: var(--next-border);
            position: relative;
            box-sizing: border-box;
        }
        
        .time-cell.next::before {
            content: "";
            position: absolute;
            top: 3px;
            right: 3px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--pri);
        }
        
        .hidden { display: none; }
        
        .legend {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            justify-content: center;
            flex-wrap: wrap;
            font-size: 0.9rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }
        
        .legend-color.regular { background-color: var(--bg); }
        .legend-color.special { background-color: var(--special-bg); }
        
        .legend-color.inter {
            background-color: var(--bg);
            position: relative;
        }
        
        .legend-color.inter::after {
            content: "•";
            position: absolute;
            top: -5px;
            right: -1px;
            color: var(--txt-sec);
            font-size: 16px;
            font-weight: bold;
        }
        
        .legend-color.next {
            background-color: var(--bg);
            border: 2px solid var(--pri);
            position: relative;
        }
        
        .legend-color.next::after {
            content: "";
            position: absolute;
            top: 1px;
            right: 1px;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background-color: var(--pri);
        }
        
        @media (max-width: 768px) {
            .top-ctl { flex-direction: column; align-items: center; gap: 10px; }
            .sched-head { flex-direction: column; align-items: flex-start; }
            .sched-title { margin-bottom: 10px; }
        }
        
        @media (max-width: 600px) {
            body { padding: 10px; }
            .next-bus-card { flex: 1 1 100%; }
            .time-grid { grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); }
            .search-cont { flex-direction: column; gap: 10px; }
            .search-inp { margin-right: 0; margin-bottom: 10px; }
            .time-cont { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <header>
        <div class="top-ctl">
            <div class="lang-tog">
                <button id="en-tog" class="active">English</button>
                <button id="zh-tog">中文</button>
            </div>
        </div>
        
        <div class="est-tog">
            <button id="vr-tog" class="active" data-en="Villa Rhapsody" data-zh="凱琴居">Villa Rhapsody</button>
            <button id="vc-tog" data-en="Villa Concerto" data-zh="凱弦居">Villa Concerto</button>
        </div>
        
        <div class="dt-cont">
            <div class="dt-card">
                <div class="date-display" id="cur-date"></div>
                <div class="time-cont" id="cur-time">
                    <div class="time-unit">
                        <div class="time-val" id="hours">00</div>
                        <div class="time-lab" data-en="Hours" data-zh="時">Hours</div>
                    </div>
                    <div class="time-sep">:</div>
                    <div class="time-unit">
                        <div class="time-val" id="minutes">00</div>
                        <div class="time-lab" data-en="Minutes" data-zh="分">Minutes</div>
                    </div>
                    <div class="time-sep">:</div>
                    <div class="time-unit">
                        <div class="time-val" id="seconds">00</div>
                        <div class="time-lab" data-en="Seconds" data-zh="秒">Seconds</div>
                    </div>
                </div>
                <div class="day-cont">
                    <div class="day-disp" id="day-type">Weekday</div>
                    <div class="holiday-name hidden" id="holiday-name"></div>
                </div>
            </div>
        </div>
    </header>
    
    <div class="tabs">
        <button class="tab active" id="tab-cur" data-en="Next Buses" data-zh="下一班車">Next Buses</button>
        <button class="tab" id="tab-sched" data-en="Full Schedule" data-zh="完整時間表">Full Schedule</button>
    </div>
    
    <!-- Villa Rhapsody View -->
    <div id="vr-view">
        <div id="cur-vr">
            <div class="section-title" data-en="Main Route" data-zh="主線">Main Route</div>
            <div class="next-buses">
                <div class="next-bus-card">
                    <h3>
                        <span data-en="From New Town Plaza to Villa Rhapsody" data-zh="由新城市廣場往凱琴居">From New Town Plaza to Villa Rhapsody</span>
                    </h3>
                    <div class="time-disp" id="next-ntp-vr">--:--</div>
                    <div class="cdown" id="cdown-ntp-vr">Loading...</div>
                    <div class="cdown-bar-cont">
                        <div class="cdown-bar" id="prog-ntp-vr"></div>
                    </div>
                    <div class="spec-note" id="spec-ntp-vr"></div>
                    <div class="stops-note" id="stops-ntp-vr"></div>
                </div>
                
                <div class="next-bus-card">
                    <h3>
                        <span data-en="From Villa Rhapsody to New Town Plaza" data-zh="由凱琴居往新城市廣場">From Villa Rhapsody to New Town Plaza</span>
                    </h3>
                    <div class="time-disp" id="next-vr-ntp">--:--</div>
                    <div class="cdown" id="cdown-vr-ntp">Loading...</div>
                    <div class="cdown-bar-cont">
                        <div class="cdown-bar" id="prog-vr-ntp"></div>
                    </div>
                    <div class="spec-note" id="spec-vr-ntp"></div>
                    <div class="stops-note" id="stops-vr-ntp"></div>
                </div>
            </div>
            
            <div class="section-title" data-en="Short Route" data-zh="短途線">Short Route</div>
            <div class="next-buses">
                <div class="next-bus-card">
                    <h3>
                        <span data-en="From Sunshine City to Villa Rhapsody" data-zh="由新港城往凱琴居">From Sunshine City to Villa Rhapsody</span>
                    </h3>
                    <div class="time-disp" id="next-sc-vr">--:--</div>
                    <div class="cdown" id="cdown-sc-vr">Loading...</div>
                    <div class="cdown-bar-cont">
                        <div class="cdown-bar" id="prog-sc-vr"></div>
                    </div>
                    <div class="spec-note" id="spec-sc-vr"></div>
                    <div class="stops-note" id="stops-sc-vr"></div>
                </div>
                
                <div class="next-bus-card">
                    <h3>
                        <span data-en="From Villa Rhapsody to Sunshine City" data-zh="由凱琴居往新港城">From Villa Rhapsody to Sunshine City</span>
                    </h3>
                    <div class="time-disp" id="next-vr-sc">--:--</div>
                    <div class="cdown" id="cdown-vr-sc">Loading...</div>
                    <div class="cdown-bar-cont">
                        <div class="cdown-bar" id="prog-vr-sc"></div>
                    </div>
                    <div class="spec-note" id="spec-vr-sc"></div>
                    <div class="stops-note" id="stops-vr-sc"></div>
                </div>
            </div>
        </div>
        
        <div id="sched-vr" class="hidden">
            <div class="sched-cont">
                <div class="sched-head">
                    <div class="sched-title" id="sched-title-vr">Bus Schedule</div>
                    <div class="controls">
                        <select id="route-sel-vr">
                            <option value="ntp-vr" data-en="New Town Plaza to Villa Rhapsody (Main)" data-zh="由新城市廣場往凱琴居 (主線)">New Town Plaza to Villa Rhapsody (Main)</option>
                            <option value="vr-ntp" data-en="Villa Rhapsody to New Town Plaza (Main)" data-zh="由凱琴居往新城市廣場 (主線)">Villa Rhapsody to New Town Plaza (Main)</option>
                            <option value="sc-vr" data-en="Sunshine City to Villa Rhapsody (Short)" data-zh="由新港城往凱琴居 (短途線)">Sunshine City to Villa Rhapsody (Short)</option>
                            <option value="vr-sc" data-en="Villa Rhapsody to Sunshine City (Short)" data-zh="由凱琴居往新港城 (短途線)">Villa Rhapsody to Sunshine City (Short)</option>
                        </select>
                        <select id="day-sel-vr">
                            <option value="weekday" data-en="Monday to Friday" data-zh="星期一至星期五">Monday to Friday</option>
                            <option value="weekend" data-en="Saturday, Sunday & Holiday" data-zh="星期六/日及公眾假期">Saturday, Sunday & Holiday</option>
                        </select>
                    </div>
                </div>
                
                <div class="search-cont">
                    <input type="text" id="time-search-vr" class="search-inp" placeholder="Search time (e.g. 08:30)" data-placeholder-en="Search time (e.g. 08:30)" data-placeholder-zh="搜尋時間 (例如 08:30)">
                    <button id="clear-vr" class="clear-search" data-en="Clear" data-zh="清除">Clear</button>
                </div>
                
                <div class="time-grid" id="grid-vr"></div>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color regular"></div>
                        <span data-en="Regular Service" data-zh="正常班次">Regular Service</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color special"></div>
                        <span data-en="Special Run" data-zh="特別班次">Special Run</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color next"></div>
                        <span data-en="Next Bus" data-zh="下一班車">Next Bus</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color inter"></div>
                        <span data-en="Stops at Villa Concerto" data-zh="途經凱弦居">Stops at Villa Concerto</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Villa Concerto View -->
    <div id="vc-view" class="hidden">
        <div id="cur-vc">
            <div class="section-title" data-en="Main Route" data-zh="主線">Main Route</div>
            <div class="next-buses">
                <div class="next-bus-card">
                    <h3>
                        <span data-en="From New Town Plaza to Villa Concerto" data-zh="由新城市廣場往凱弦居">From New Town Plaza to Villa Concerto</span>
                    </h3>
                    <div class="time-disp" id="next-ntp-vc">--:--</div>
                    <div class="cdown" id="cdown-ntp-vc">Loading...</div>
                    <div class="cdown-bar-cont">
                        <div class="cdown-bar" id="prog-ntp-vc"></div>
                    </div>
                    <div class="spec-note" id="spec-ntp-vc"></div>
                    <div class="stops-note" id="stops-ntp-vc"></div>
                </div>
                
                <div class="next-bus-card">
                    <h3>
                        <span data-en="From Villa Concerto to New Town Plaza" data-zh="由凱弦居往新城市廣場">From Villa Concerto to New Town Plaza</span>
                    </h3>
                    <div class="time-disp" id="next-vc-ntp">--:--</div>
                    <div class="cdown" id="cdown-vc-ntp">Loading...</div>
                    <div class="cdown-bar-cont">
                        <div class="cdown-bar" id="prog-vc-ntp"></div>
                    </div>
                    <div class="spec-note" id="spec-vc-ntp"></div>
                    <div class="stops-note" id="stops-vc-ntp"></div>
                </div>
            </div>
            
            <div class="section-title" data-en="Short Route" data-zh="短途線">Short Route</div>
            <div class="next-buses">
                <div class="next-bus-card">
                    <h3>
                        <span data-en="From Sunshine City to Villa Concerto" data-zh="由新港城往凱弦居">From Sunshine City to Villa Concerto</span>
                    </h3>
                    <div class="time-disp" id="next-sc-vc">--:--</div>
                    <div class="cdown" id="cdown-sc-vc">Loading...</div>
                    <div class="cdown-bar-cont">
                        <div class="cdown-bar" id="prog-sc-vc"></div>
                    </div>
                    <div class="spec-note" id="spec-sc-vc"></div>
                    <div class="stops-note" id="stops-sc-vc"></div>
                </div>
                
                <div class="next-bus-card">
                    <h3>
                        <span data-en="From Villa Concerto to Sunshine City" data-zh="由凱弦居往新港城">From Villa Concerto to Sunshine City</span>
                    </h3>
                    <div class="time-disp" id="next-vc-sc">--:--</div>
                    <div class="cdown" id="cdown-vc-sc">Loading...</div>
                    <div class="cdown-bar-cont">
                        <div class="cdown-bar" id="prog-vc-sc"></div>
                    </div>
                    <div class="spec-note" id="spec-vc-sc"></div>
                    <div class="stops-note" id="stops-vc-sc"></div>
                </div>
            </div>
        </div>
        
        <div id="sched-vc" class="hidden">
            <div class="sched-cont">
                <div class="sched-head">
                    <div class="sched-title" id="sched-title-vc">Bus Schedule</div>
                    <div class="controls">
                        <select id="route-sel-vc">
                            <option value="ntp-vc" data-en="New Town Plaza to Villa Concerto (Main)" data-zh="由新城市廣場往凱弦居 (主線)">New Town Plaza to Villa Concerto (Main)</option>
                            <option value="vc-ntp" data-en="Villa Concerto to New Town Plaza (Main)" data-zh="由凱弦居往新城市廣場 (主線)">Villa Concerto to New Town Plaza (Main)</option>
                            <option value="sc-vc" data-en="Sunshine City to Villa Concerto (Short)" data-zh="由新港城往凱弦居 (短途線)">Sunshine City to Villa Concerto (Short)</option>
                            <option value="vc-sc" data-en="Villa Concerto to Sunshine City (Short)" data-zh="由凱弦居往新港城 (短途線)">Villa Concerto to Sunshine City (Short)</option>
                        </select>
                        <select id="day-sel-vc">
                            <option value="weekday" data-en="Monday to Friday" data-zh="星期一至星期五">Monday to Friday</option>
                            <option value="weekend" data-en="Saturday, Sunday & Holiday" data-zh="星期六/日及公眾假期">Saturday, Sunday & Holiday</option>
                        </select>
                    </div>
                </div>
                
                <div class="search-cont">
                    <input type="text" id="time-search-vc" class="search-inp" placeholder="Search time (e.g. 08:30)" data-placeholder-en="Search time (e.g. 08:30)" data-placeholder-zh="搜尋時間 (例如 08:30)">
                    <button id="clear-vc" class="clear-search" data-en="Clear" data-zh="清除">Clear</button>
                </div>
                
                <div class="time-grid" id="grid-vc"></div>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color regular"></div>
                        <span data-en="Regular Service" data-zh="正常班次">Regular Service</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color special"></div>
                        <span data-en="Special Run" data-zh="特別班次">Special Run</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color next"></div>
                        <span data-en="Next Bus" data-zh="下一班車">Next Bus</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color inter"></div>
                        <span data-en="Stops at Villa Rhapsody" data-zh="途經凱琴居">Stops at Villa Rhapsody</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const D = {
            vrTog: document.getElementById('vr-tog'),
            vcTog: document.getElementById('vc-tog'),
            vrView: document.getElementById('vr-view'),
            vcView: document.getElementById('vc-view'),
            
            tabCur: document.getElementById('tab-cur'),
            tabSched: document.getElementById('tab-sched'),
            curVR: document.getElementById('cur-vr'),
            schedVR: document.getElementById('sched-vr'),
            curVC: document.getElementById('cur-vc'),
            schedVC: document.getElementById('sched-vc'),
            
            routeSelVR: document.getElementById('route-sel-vr'),
            daySelVR: document.getElementById('day-sel-vr'),
            gridVR: document.getElementById('grid-vr'),
            schedTitleVR: document.getElementById('sched-title-vr'),
            
            routeSelVC: document.getElementById('route-sel-vc'),
            daySelVC: document.getElementById('day-sel-vc'),
            gridVC: document.getElementById('grid-vc'),
            schedTitleVC: document.getElementById('sched-title-vc'),
            
            searchVR: document.getElementById('time-search-vr'),
            clearVR: document.getElementById('clear-vr'),
            searchVC: document.getElementById('time-search-vc'),
            clearVC: document.getElementById('clear-vc'),
            
            nextNTPVR: {
                time: document.getElementById('next-ntp-vr'),
                cdown: document.getElementById('cdown-ntp-vr'),
                prog: document.getElementById('prog-ntp-vr'),
                note: document.getElementById('spec-ntp-vr'),
                stops: document.getElementById('stops-ntp-vr')
            },
            nextVRNTP: {
                time: document.getElementById('next-vr-ntp'),
                cdown: document.getElementById('cdown-vr-ntp'),
                prog: document.getElementById('prog-vr-ntp'),
                note: document.getElementById('spec-vr-ntp'),
                stops: document.getElementById('stops-vr-ntp')
            },
            
            nextSCVR: {
                time: document.getElementById('next-sc-vr'),
                cdown: document.getElementById('cdown-sc-vr'),
                prog: document.getElementById('prog-sc-vr'),
                note: document.getElementById('spec-sc-vr'),
                stops: document.getElementById('stops-sc-vr')
            },
            nextVRSC: {
                time: document.getElementById('next-vr-sc'),
                cdown: document.getElementById('cdown-vr-sc'),
                prog: document.getElementById('prog-vr-sc'),
                note: document.getElementById('spec-vr-sc'),
                stops: document.getElementById('stops-vr-sc')
            },
            
            nextNTPVC: {
                time: document.getElementById('next-ntp-vc'),
                cdown: document.getElementById('cdown-ntp-vc'),
                prog: document.getElementById('prog-ntp-vc'),
                note: document.getElementById('spec-ntp-vc'),
                stops: document.getElementById('stops-ntp-vc')
            },
            nextVCNTP: {
                time: document.getElementById('next-vc-ntp'),
                cdown: document.getElementById('cdown-vc-ntp'),
                prog: document.getElementById('prog-vc-ntp'),
                note: document.getElementById('spec-vc-ntp'),
                stops: document.getElementById('stops-vc-ntp')
            },
            
            nextSCVC: {
                time: document.getElementById('next-sc-vc'),
                cdown: document.getElementById('cdown-sc-vc'),
                prog: document.getElementById('prog-sc-vc'),
                note: document.getElementById('spec-sc-vc'),
                stops: document.getElementById('stops-sc-vc')
            },
            nextVCSC: {
                time: document.getElementById('next-vc-sc'),
                cdown: document.getElementById('cdown-vc-sc'),
                prog: document.getElementById('prog-vc-sc'),
                note: document.getElementById('spec-vc-sc'),
                stops: document.getElementById('stops-vc-sc')
            },
            
            enTog: document.getElementById('en-tog'),
            zhTog: document.getElementById('zh-tog'),
            
            curDate: document.getElementById('cur-date'),
            hours: document.getElementById('hours'),
            minutes: document.getElementById('minutes'),
            seconds: document.getElementById('seconds'),
            dayType: document.getElementById('day-type'),
            holidayName: document.getElementById('holiday-name')
        };

        const interRoutes = {
            'vr': {
                'vr-ntp': 'vc',
                'vr-sc': 'vc'
            },
            'vc': {
                'ntp-vc': 'vr',
                'vc-ntp': 'vr',
                'vc-sc': 'vr'
            }
        };
        
        const specVia = {
            'vr': {
                'ntp-vr': 'sc',
                'sc-vr': 'vc'
            },
            'vc': {
                'ntp-vc': 'sc',
                'sc-vc': 'ntp'
            }
        };

        const schVR = {
            "ntp-vr": {
                "weekday": [
                    {time: "06:35", special: false},
                    {time: "06:50", special: false},
                    {time: "07:00", special: false},
                    {time: "07:15", special: false},
                    {time: "07:25", special: false},
                    {time: "07:35", special: false},
                    {time: "07:50", special: false},
                    {time: "08:00", special: false},
                    {time: "08:10", special: false},
                    {time: "08:25", special: false},
                    {time: "08:35", special: false},
                    {time: "08:45", special: false},
                    {time: "09:00", special: false},
                    {time: "09:15", special: false},
                    {time: "09:35", special: false},
                    {time: "09:55", special: false},
                    {time: "10:15", special: false},
                    {time: "10:35", special: false},
                    {time: "10:55", special: false},
                    {time: "11:15", special: false},
                    {time: "11:35", special: false},
                    {time: "11:55", special: false},
                    {time: "12:15", special: false},
                    {time: "12:35", special: false},
                    {time: "12:55", special: false},
                    {time: "13:15", special: false},
                    {time: "13:45", special: true},
                    {time: "14:20", special: false},
                    {time: "14:45", special: true},
                    {time: "15:20", special: false},
                    {time: "15:35", special: false},
                    {time: "15:55", special: false},
                    {time: "16:15", special: false},
                    {time: "16:30", special: false},
                    {time: "16:45", special: false},
                    {time: "17:00", special: false},
                    {time: "17:15", special: false},
                    {time: "17:30", special: false},
                    {time: "17:45", special: false},
                    {time: "18:00", special: false},
                    {time: "18:15", special: false},
                    {time: "18:30", special: false},
                    {time: "18:45", special: false},
                    {time: "19:00", special: false},
                    {time: "19:15", special: false},
                    {time: "19:30", special: false},
                    {time: "19:45", special: false},
                    {time: "20:00", special: true},
                    {time: "20:15", special: true},
                    {time: "20:40", special: true},
                    {time: "21:00", special: true},
                    {time: "21:20", special: true},
                    {time: "21:40", special: true},
                    {time: "22:00", special: true},
                    {time: "22:30", special: true},
                    {time: "23:00", special: true}
                ],
                "weekend": [
                    {time: "06:35", special: false},
                    {time: "06:55", special: false},
                    {time: "07:15", special: false},
                    {time: "07:35", special: false},
                    {time: "07:55", special: false},
                    {time: "08:15", special: false},
                    {time: "08:30", special: false},
                    {time: "08:45", special: false},
                    {time: "09:00", special: false},
                    {time: "09:15", special: false},
                    {time: "09:35", special: false},
                    {time: "09:55", special: false},
                    {time: "10:15", special: false},
                    {time: "10:35", special: false},
                    {time: "10:55", special: false},
                    {time: "11:15", special: false},
                    {time: "11:35", special: false},
                    {time: "11:55", special: false},
                    {time: "12:15", special: false},
                    {time: "12:35", special: false},
                    {time: "12:55", special: false},
                    {time: "13:15", special: false},
                    {time: "13:35", special: false},
                    {time: "13:55", special: false},
                    {time: "14:15", special: false},
                    {time: "14:35", special: false},
                    {time: "14:55", special: false},
                    {time: "15:15", special: false},
                    {time: "15:35", special: false},
                    {time: "15:55", special: false},
                    {time: "16:15", special: false},
                    {time: "16:30", special: false},
                    {time: "16:45", special: false},
                    {time: "17:00", special: false},
                    {time: "17:15", special: false},
                    {time: "17:30", special: false},
                    {time: "17:45", special: false},
                    {time: "18:00", special: false},
                    {time: "18:15", special: false},
                    {time: "18:30", special: false},
                    {time: "18:45", special: false},
                    {time: "19:00", special: false},
                    {time: "19:15", special: false},
                    {time: "19:30", special: false},
                    {time: "19:45", special: false},
                    {time: "20:00", special: false},
                    {time: "20:15", special: false},
                    {time: "20:35", special: true},
                    {time: "21:00", special: true},
                    {time: "21:20", special: true},
                    {time: "21:40", special: true},
                    {time: "22:00", special: true},
                    {time: "22:30", special: true},
                    {time: "23:00", special: true}
                ]
            },
            "vr-ntp": {
                "weekday": [
                    {time: "06:16", special: true},
                    {time: "06:31", special: true},
                    {time: "06:41", special: true},
                    {time: "07:01", special: false},
                    {time: "07:11", special: false},
                    {time: "07:21", special: false},
                    {time: "07:36", special: false},
                    {time: "07:46", special: false},
                    {time: "07:56", special: false},
                    {time: "08:11", special: false},
                    {time: "08:21", special: false},
                    {time: "08:31", special: false},
                    {time: "08:46", special: false},
                    {time: "09:01", special: false},
                    {time: "09:21", special: false},
                    {time: "09:41", special: false},
                    {time: "10:01", special: false},
                    {time: "10:21", special: false},
                    {time: "10:41", special: false},
                    {time: "11:01", special: false},
                    {time: "11:21", special: false},
                    {time: "11:41", special: false},
                    {time: "12:01", special: false},
                    {time: "12:21", special: false},
                    {time: "12:41", special: false},
                    {time: "13:01", special: false},
                    {time: "13:31", special: false},
                    {time: "14:01", special: true},
                    {time: "14:30", special: false},
                    {time: "15:01", special: true},
                    {time: "15:21", special: false},
                    {time: "15:41", special: false},
                    {time: "16:01", special: false},
                    {time: "16:11", special: false},
                    {time: "16:31", special: false},
                    {time: "16:46", special: false},
                    {time: "17:01", special: false},
                    {time: "17:16", special: false},
                    {time: "17:31", special: false},
                    {time: "17:46", special: false},
                    {time: "18:01", special: false},
                    {time: "18:16", special: false},
                    {time: "18:31", special: false},
                    {time: "18:46", special: false},
                    {time: "19:01", special: false},
                    {time: "19:16", special: false},
                    {time: "19:31", special: false},
                    {time: "19:46", special: false},
                    {time: "20:01", special: false},
                    {time: "20:21", special: true},
                    {time: "20:41", special: true},
                    {time: "21:01", special: true},
                    {time: "21:21", special: true},
                    {time: "21:41", special: true},
                    {time: "22:11", special: true},
                    {time: "22:41", special: true}
                ],
                "weekend": [
                    {time: "06:16", special: true},
                    {time: "06:36", special: true},
                    {time: "07:01", special: false},
                    {time: "07:21", special: false},
                    {time: "07:41", special: false},
                    {time: "08:01", special: false},
                    {time: "08:16", special: false},
                    {time: "08:31", special: false},
                    {time: "08:46", special: false},
                    {time: "09:01", special: false},
                    {time: "09:21", special: false},
                    {time: "09:41", special: false},
                    {time: "10:01", special: false},
                    {time: "10:21", special: false},
                    {time: "10:41", special: false},
                    {time: "11:01", special: false},
                    {time: "11:21", special: false},
                    {time: "11:41", special: false},
                    {time: "12:01", special: false},
                    {time: "12:21", special: false},
                    {time: "12:41", special: false},
                    {time: "13:01", special: false},
                    {time: "13:21", special: false},
                    {time: "13:41", special: false},
                    {time: "14:01", special: false},
                    {time: "14:21", special: false},
                    {time: "14:41", special: false},
                    {time: "15:01", special: false},
                    {time: "15:21", special: false},
                    {time: "15:41", special: false},
                    {time: "16:01", special: false},
                    {time: "16:16", special: false},
                    {time: "16:31", special: false},
                    {time: "16:46", special: false},
                    {time: "17:01", special: false},
                    {time: "17:16", special: false},
                    {time: "17:31", special: false},
                    {time: "17:46", special: false},
                    {time: "18:01", special: false},
                    {time: "18:16", special: false},
                    {time: "18:31", special: false},
                    {time: "18:46", special: false},
                    {time: "19:01", special: false},
                    {time: "19:16", special: false},
                    {time: "19:31", special: false},
                    {time: "19:46", special: false},
                    {time: "20:01", special: false},
                    {time: "20:21", special: false},
                    {time: "20:41", special: true},
                    {time: "21:01", special: true},
                    {time: "21:21", special: true},
                    {time: "21:41", special: true},
                    {time: "22:11", special: true},
                    {time: "22:41", special: true}
                ]
            },
            "sc-vr": {
                "weekday": [
                    {time: "07:10", special: false},
                    {time: "07:22", special: false},
                    {time: "07:27", special: false},
                    {time: "07:37", special: false},
                    {time: "07:47", special: false},
                    {time: "07:57", special: false},
                    {time: "08:07", special: false},
                    {time: "08:17", special: false},
                    {time: "08:27", special: false},
                    {time: "08:37", special: false},
                    {time: "08:47", special: false},
                    {time: "08:57", special: false},
                    {time: "09:10", special: false},
                    {time: "09:30", special: false},
                    {time: "09:50", special: false},
                    {time: "10:10", special: false},
                    {time: "10:30", special: false},
                    {time: "10:50", special: false},
                    {time: "11:10", special: false},
                    {time: "11:30", special: false},
                    {time: "11:50", special: false},
                    {time: "12:10", special: false},
                    {time: "12:30", special: false},
                    {time: "12:50", special: false},
                    {time: "13:10", special: false},
                    {time: "13:30", special: false},
                    {time: "13:50", special: false},
                    {time: "14:00", special: true},
                    {time: "14:30", special: false},
                    {time: "14:50", special: false},
                    {time: "15:00", special: true},
                    {time: "15:30", special: false},
                    {time: "15:50", special: false},
                    {time: "16:10", special: false},
                    {time: "16:30", special: false},
                    {time: "16:50", special: false},
                    {time: "17:10", special: false},
                    {time: "17:30", special: false},
                    {time: "17:50", special: false},
                    {time: "18:10", special: false},
                    {time: "18:30", special: false},
                    {time: "18:50", special: false},
                    {time: "19:10", special: false},
                    {time: "19:30", special: false},
                    {time: "19:50", special: false},
                    {time: "20:10", special: false},
                    {time: "20:15", special: true},
                    {time: "20:30", special: true},
                    {time: "20:55", special: true},
                    {time: "21:15", special: true},
                    {time: "21:35", special: true},
                    {time: "21:55", special: true},
                    {time: "22:15", special: true},
                    {time: "22:45", special: true},
                    {time: "23:15", special: true}
                ],
                "weekend": [
                    {time: "07:10", special: false},
                    {time: "07:30", special: false},
                    {time: "07:50", special: false},
                    {time: "08:10", special: false},
                    {time: "08:30", special: false},
                    {time: "08:50", special: false},
                    {time: "09:10", special: false},
                    {time: "09:30", special: false},
                    {time: "09:50", special: false},
                    {time: "10:10", special: false},
                    {time: "10:30", special: false},
                    {time: "10:50", special: false},
                    {time: "11:10", special: false},
                    {time: "11:30", special: false},
                    {time: "11:50", special: false},
                    {time: "12:10", special: false},
                    {time: "12:30", special: false},
                    {time: "12:50", special: false},
                    {time: "13:10", special: false},
                    {time: "13:30", special: false},
                    {time: "13:50", special: false},
                    {time: "14:10", special: false},
                    {time: "14:30", special: false},
                    {time: "14:50", special: false},
                    {time: "15:10", special: false},
                    {time: "15:30", special: false},
                    {time: "15:50", special: false},
                    {time: "16:10", special: false},
                    {time: "16:30", special: false},
                    {time: "16:50", special: false},
                    {time: "17:10", special: false},
                    {time: "17:30", special: false},
                    {time: "17:50", special: false},
                    {time: "18:10", special: false},
                    {time: "18:30", special: false},
                    {time: "18:50", special: false},
                    {time: "19:10", special: false},
                    {time: "19:30", special: false},
                    {time: "19:50", special: false},
                    {time: "20:10", special: false},
                    {time: "20:30", special: false},
                    {time: "20:50", special: true},
                    {time: "21:15", special: true},
                    {time: "21:35", special: true},
                    {time: "21:55", special: true},
                    {time: "22:15", special: true},
                    {time: "22:45", special: true},
                    {time: "23:15", special: true}
                ]
            },
            "vr-sc": {
                "weekday": [
                    {time: "06:15", special: true},
                    {time: "06:30", special: true},
                    {time: "06:40", special: true},
                    {time: "07:00", special: false},
                    {time: "07:15", special: false},
                    {time: "07:20", special: false},
                    {time: "07:30", special: false},
                    {time: "07:40", special: false},
                    {time: "07:50", special: false},
                    {time: "08:00", special: false},
                    {time: "08:10", special: false},
                    {time: "08:20", special: false},
                    {time: "08:30", special: false},
                    {time: "08:40", special: false},
                    {time: "08:50", special: false},
                    {time: "09:00", special: false},
                    {time: "09:20", special: false},
                    {time: "09:40", special: false},
                    {time: "10:00", special: false},
                    {time: "10:20", special: false},
                    {time: "10:40", special: false},
                    {time: "11:00", special: false},
                    {time: "11:20", special: false},
                    {time: "11:40", special: false},
                    {time: "12:00", special: false},
                    {time: "12:20", special: false},
                    {time: "12:40", special: false},
                    {time: "13:00", special: false},
                    {time: "13:20", special: false},
                    {time: "13:40", special: false},
                    {time: "14:00", special: true},
                    {time: "14:20", special: false},
                    {time: "14:40", special: false},
                    {time: "15:00", special: true},
                    {time: "15:20", special: false},
                    {time: "15:40", special: false},
                    {time: "16:00", special: false},
                    {time: "16:20", special: false},
                    {time: "16:40", special: false},
                    {time: "17:00", special: false},
                    {time: "17:20", special: false},
                    {time: "17:40", special: false},
                    {time: "18:00", special: false},
                    {time: "18:20", special: false},
                    {time: "18:40", special: false},
                    {time: "19:00", special: false},
                    {time: "19:20", special: false},
                    {time: "19:40", special: false},
                    {time: "20:00", special: false},
                    {time: "20:20", special: true},
                    {time: "20:40", special: true},
                    {time: "21:00", special: true},
                    {time: "21:20", special: true},
                    {time: "21:40", special: true},
                    {time: "22:10", special: true},
                    {time: "22:40", special: true}
                ],
                "weekend": [
                    {time: "06:15", special: true},
                    {time: "06:35", special: true},
                    {time: "07:00", special: false},
                    {time: "07:20", special: false},
                    {time: "07:40", special: false},
                    {time: "08:00", special: false},
                    {time: "08:20", special: false},
                    {time: "08:40", special: false},
                    {time: "09:00", special: false},
                    {time: "09:20", special: false},
                    {time: "09:40", special: false},
                    {time: "10:00", special: false},
                    {time: "10:20", special: false},
                    {time: "10:40", special: false},
                    {time: "11:00", special: false},
                    {time: "11:20", special: false},
                    {time: "11:40", special: false},
                    {time: "12:00", special: false},
                    {time: "12:20", special: false},
                    {time: "12:40", special: false},
                    {time: "13:00", special: false},
                    {time: "13:20", special: false},
                    {time: "13:40", special: false},
                    {time: "14:00", special: false},
                    {time: "14:20", special: false},
                    {time: "14:40", special: false},
                    {time: "15:00", special: false},
                    {time: "15:20", special: false},
                    {time: "15:40", special: false},
                    {time: "16:00", special: false},
                    {time: "16:20", special: false},
                    {time: "16:40", special: false},
                    {time: "17:00", special: false},
                    {time: "17:20", special: false},
                    {time: "17:40", special: false},
                    {time: "18:00", special: false},
                    {time: "18:20", special: false},
                    {time: "18:40", special: false},
                    {time: "19:00", special: false},
                    {time: "19:20", special: false},
                    {time: "19:40", special: false},
                    {time: "20:00", special: false},
                    {time: "20:20", special: false},
                    {time: "20:40", special: true},
                    {time: "21:00", special: true},
                    {time: "21:20", special: true},
                    {time: "21:40", special: true},
                    {time: "22:10", special: true},
                    {time: "22:40", special: true}
                ]
            }
        };
        
        const schVC = {
            "ntp-vc": {
                "weekday": [
                    {time: "06:35", special: false},
                    {time: "06:50", special: false},
                    {time: "07:00", special: false},
                    {time: "07:15", special: false},
                    {time: "07:25", special: false},
                    {time: "07:35", special: false},
                    {time: "07:50", special: false},
                    {time: "08:00", special: false},
                    {time: "08:10", special: false},
                    {time: "08:25", special: false},
                    {time: "08:35", special: false},
                    {time: "08:45", special: false},
                    {time: "09:00", special: false},
                    {time: "09:15", special: false},
                    {time: "09:35", special: false},
                    {time: "09:55", special: false},
                    {time: "10:15", special: false},
                    {time: "10:35", special: false},
                    {time: "10:55", special: false},
                    {time: "11:15", special: false},
                    {time: "11:35", special: false},
                    {time: "11:55", special: false},
                    {time: "12:15", special: false},
                    {time: "12:35", special: false},
                    {time: "12:55", special: false},
                    {time: "13:15", special: false},
                    {time: "13:45", special: true},
                    {time: "14:20", special: false},
                    {time: "14:45", special: true},
                    {time: "15:20", special: false},
                    {time: "15:35", special: false},
                    {time: "15:55", special: false},
                    {time: "16:15", special: false},
                    {time: "16:30", special: false},
                    {time: "16:45", special: false},
                    {time: "17:00", special: false},
                    {time: "17:15", special: false},
                    {time: "17:30", special: false},
                    {time: "17:45", special: false},
                    {time: "18:00", special: false},
                    {time: "18:15", special: false},
                    {time: "18:30", special: false},
                    {time: "18:45", special: false},
                    {time: "19:00", special: false},
                    {time: "19:15", special: false},
                    {time: "19:30", special: false},
                    {time: "19:45", special: false},
                    {time: "20:00", special: true},
                    {time: "20:15", special: true},
                    {time: "20:40", special: true},
                    {time: "21:00", special: true},
                    {time: "21:20", special: true},
                    {time: "21:40", special: true},
                    {time: "22:00", special: true},
                    {time: "22:30", special: true},
                    {time: "23:00", special: true}
                ],
                "weekend": [
                    {time: "06:35", special: false},
                    {time: "06:55", special: false},
                    {time: "07:15", special: false},
                    {time: "07:35", special: false},
                    {time: "07:55", special: false},
                    {time: "08:15", special: false},
                    {time: "08:30", special: false},
                    {time: "08:45", special: false},
                    {time: "09:00", special: false},
                    {time: "09:15", special: false},
                    {time: "09:35", special: false},
                    {time: "09:55", special: false},
                    {time: "10:15", special: false},
                    {time: "10:35", special: false},
                    {time: "10:55", special: false},
                    {time: "11:15", special: false},
                    {time: "11:35", special: false},
                    {time: "11:55", special: false},
                    {time: "12:15", special: false},
                    {time: "12:35", special: false},
                    {time: "12:55", special: false},
                    {time: "13:15", special: false},
                    {time: "13:35", special: false},
                    {time: "13:55", special: false},
                    {time: "14:15", special: false},
                    {time: "14:35", special: false},
                    {time: "14:55", special: false},
                    {time: "15:15", special: false},
                    {time: "15:35", special: false},
                    {time: "15:55", special: false},
                    {time: "16:15", special: false},
                    {time: "16:30", special: false},
                    {time: "16:45", special: false},
                    {time: "17:00", special: false},
                    {time: "17:15", special: false},
                    {time: "17:30", special: false},
                    {time: "17:45", special: false},
                    {time: "18:00", special: false},
                    {time: "18:15", special: false},
                    {time: "18:30", special: false},
                    {time: "18:45", special: false},
                    {time: "19:00", special: false},
                    {time: "19:15", special: false},
                    {time: "19:30", special: false},
                    {time: "19:45", special: false},
                    {time: "20:00", special: false},
                    {time: "20:15", special: false},
                    {time: "20:35", special: true},
                    {time: "21:00", special: true},
                    {time: "21:20", special: true},
                    {time: "21:40", special: true},
                    {time: "22:00", special: true},
                    {time: "22:30", special: true},
                    {time: "23:00", special: true}
                ]
            },
            "vc-ntp": {
                "weekday": [
                    {time: "06:15", special: true},
                    {time: "06:30", special: true},
                    {time: "06:40", special: true},
                    {time: "07:00", special: false},
                    {time: "07:10", special: false},
                    {time: "07:20", special: false},
                    {time: "07:35", special: false},
                    {time: "07:45", special: false},
                    {time: "07:55", special: false},
                    {time: "08:10", special: false},
                    {time: "08:20", special: false},
                    {time: "08:30", special: false},
                    {time: "08:45", special: false},
                    {time: "09:00", special: false},
                    {time: "09:20", special: false},
                    {time: "09:40", special: false},
                    {time: "10:00", special: false},
                    {time: "10:20", special: false},
                    {time: "10:40", special: false},
                    {time: "11:00", special: false},
                    {time: "11:20", special: false},
                    {time: "11:40", special: false},
                    {time: "12:00", special: false},
                    {time: "12:20", special: false},
                    {time: "12:40", special: false},
                    {time: "13:00", special: false},
                    {time: "13:30", special: false},
                    {time: "14:00", special: true},
                    {time: "14:30", special: false},
                    {time: "15:00", special: true},
                    {time: "15:20", special: false},
                    {time: "15:40", special: false},
                    {time: "16:00", special: false},
                    {time: "16:15", special: false},
                    {time: "16:30", special: false},
                    {time: "16:45", special: false},
                    {time: "17:00", special: false},
                    {time: "17:15", special: false},
                    {time: "17:30", special: false},
                    {time: "17:45", special: false},
                    {time: "18:00", special: false},
                    {time: "18:15", special: false},
                    {time: "18:30", special: false},
                    {time: "18:45", special: false},
                    {time: "19:00", special: false},
                    {time: "19:15", special: false},
                    {time: "19:30", special: false},
                    {time: "19:45", special: false},
                    {time: "20:00", special: false},
                    {time: "20:20", special: true},
                    {time: "20:40", special: true},
                    {time: "21:00", special: true},
                    {time: "21:20", special: true},
                    {time: "21:40", special: true},
                    {time: "22:10", special: true},
                    {time: "22:40", special: true}
                ],
                "weekend": [
                    {time: "06:15", special: true},
                    {time: "06:35", special: true},
                    {time: "07:00", special: false},
                    {time: "07:20", special: false},
                    {time: "07:40", special: false},
                    {time: "08:00", special: false},
                    {time: "08:15", special: false},
                    {time: "08:30", special: false},
                    {time: "08:45", special: false},
                    {time: "09:00", special: false},
                    {time: "09:20", special: false},
                    {time: "09:40", special: false},
                    {time: "10:00", special: false},
                    {time: "10:20", special: false},
                    {time: "10:40", special: false},
                    {time: "11:00", special: false},
                    {time: "11:20", special: false},
                    {time: "11:40", special: false},
                    {time: "12:00", special: false},
                    {time: "12:20", special: false},
                    {time: "12:40", special: false},
                    {time: "13:00", special: false},
                    {time: "13:20", special: false},
                    {time: "13:40", special: false},
                    {time: "14:00", special: false},
                    {time: "14:20", special: false},
                    {time: "14:40", special: false},
                    {time: "15:00", special: false},
                    {time: "15:20", special: false},
                    {time: "15:40", special: false},
                    {time: "16:00", special: false},
                    {time: "16:15", special: false},
                    {time: "16:30", special: false},
                    {time: "16:45", special: false},
                    {time: "17:00", special: false},
                    {time: "17:15", special: false},
                    {time: "17:30", special: false},
                    {time: "17:45", special: false},
                    {time: "18:00", special: false},
                    {time: "18:15", special: false},
                    {time: "18:30", special: false},
                    {time: "18:45", special: false},
                    {time: "19:00", special: false},
                    {time: "19:15", special: false},
                    {time: "19:30", special: false},
                    {time: "19:45", special: false},
                    {time: "20:00", special: false},
                    {time: "20:20", special: false},
                    {time: "20:40", special: true},
                    {time: "21:00", special: true},
                    {time: "21:20", special: true},
                    {time: "21:40", special: true},
                    {time: "22:10", special: true},
                    {time: "22:40", special: true}
                ]
            },
            "sc-vc": {
                "weekday": [
                    {time: "07:10", special: false},
                    {time: "07:22", special: false},
                    {time: "07:27", special: false},
                    {time: "07:37", special: false},
                    {time: "07:47", special: false},
                    {time: "07:57", special: false},
                    {time: "08:07", special: false},
                    {time: "08:17", special: false},
                    {time: "08:27", special: false},
                    {time: "08:37", special: false},
                    {time: "08:47", special: false},
                    {time: "08:57", special: false},
                    {time: "09:10", special: false},
                    {time: "09:30", special: false},
                    {time: "09:50", special: false},
                    {time: "10:10", special: false},
                    {time: "10:30", special: false},
                    {time: "10:50", special: false},
                    {time: "11:10", special: false},
                    {time: "11:30", special: false},
                    {time: "11:50", special: false},
                    {time: "12:10", special: false},
                    {time: "12:30", special: false},
                    {time: "12:50", special: false},
                    {time: "13:10", special: false},
                    {time: "13:30", special: false},
                    {time: "13:50", special: false},
                    {time: "14:00", special: true},
                    {time: "14:30", special: false},
                    {time: "14:50", special: false},
                    {time: "15:00", special: true},
                    {time: "15:30", special: false},
                    {time: "15:50", special: false},
                    {time: "16:10", special: false},
                    {time: "16:30", special: false},
                    {time: "16:50", special: false},
                    {time: "17:10", special: false},
                    {time: "17:30", special: false},
                    {time: "17:50", special: false},
                    {time: "18:10", special: false},
                    {time: "18:30", special: false},
                    {time: "18:50", special: false},
                    {time: "19:10", special: false},
                    {time: "19:30", special: false},
                    {time: "19:50", special: false},
                    {time: "20:10", special: false},
                    {time: "20:15", special: true},
                    {time: "20:30", special: true},
                    {time: "20:55", special: true},
                    {time: "21:15", special: true},
                    {time: "21:35", special: true},
                    {time: "21:55", special: true},
                    {time: "22:15", special: true},
                    {time: "22:45", special: true},
                    {time: "23:15", special: true}
                ],
                "weekend": [
                    {time: "07:10", special: false},
                    {time: "07:30", special: false},
                    {time: "07:50", special: false},
                    {time: "08:10", special: false},
                    {time: "08:30", special: false},
                    {time: "08:50", special: false},
                    {time: "09:10", special: false},
                    {time: "09:30", special: false},
                    {time: "09:50", special: false},
                    {time: "10:10", special: false},
                    {time: "10:30", special: false},
                    {time: "10:50", special: false},
                    {time: "11:10", special: false},
                    {time: "11:30", special: false},
                    {time: "11:50", special: false},
                    {time: "12:10", special: false},
                    {time: "12:30", special: false},
                    {time: "12:50", special: false},
                    {time: "13:10", special: false},
                    {time: "13:30", special: false},
                    {time: "13:50", special: false},
                    {time: "14:10", special: false},
                    {time: "14:30", special: false},
                    {time: "14:50", special: false},
                    {time: "15:10", special: false},
                    {time: "15:30", special: false},
                    {time: "15:50", special: false},
                    {time: "16:10", special: false},
                    {time: "16:30", special: false},
                    {time: "16:50", special: false},
                    {time: "17:10", special: false},
                    {time: "17:30", special: false},
                    {time: "17:50", special: false},
                    {time: "18:10", special: false},
                    {time: "18:30", special: false},
                    {time: "18:50", special: false},
                    {time: "19:10", special: false},
                    {time: "19:30", special: false},
                    {time: "19:50", special: false},
                    {time: "20:10", special: false},
                    {time: "20:30", special: false},
                    {time: "20:50", special: true},
                    {time: "21:15", special: true},
                    {time: "21:35", special: true},
                    {time: "21:55", special: true},
                    {time: "22:15", special: true},
                    {time: "22:45", special: true},
                    {time: "23:15", special: true}
                ]
            },
            "vc-sc": {
                "weekday": [
                    {time: "06:15", special: true},
                    {time: "06:30", special: true},
                    {time: "06:40", special: true},
                    {time: "07:00", special: false},
                    {time: "07:15", special: false},
                    {time: "07:20", special: false},
                    {time: "07:30", special: false},
                    {time: "07:40", special: false},
                    {time: "07:50", special: false},
                    {time: "08:00", special: false},
                    {time: "08:10", special: false},
                    {time: "08:20", special: false},
                    {time: "08:30", special: false},
                    {time: "08:40", special: false},
                    {time: "08:50", special: false},
                    {time: "09:00", special: false},
                    {time: "09:20", special: false},
                    {time: "09:40", special: false},
                    {time: "10:00", special: false},
                    {time: "10:20", special: false},
                    {time: "10:40", special: false},
                    {time: "11:00", special: false},
                    {time: "11:20", special: false},
                    {time: "11:40", special: false},
                    {time: "12:00", special: false},
                    {time: "12:20", special: false},
                    {time: "12:40", special: false},
                    {time: "13:00", special: false},
                    {time: "13:20", special: false},
                    {time: "13:40", special: false},
                    {time: "14:00", special: true},
                    {time: "14:20", special: false},
                    {time: "14:40", special: false},
                    {time: "15:00", special: true},
                    {time: "15:20", special: false},
                    {time: "15:40", special: false},
                    {time: "16:00", special: false},
                    {time: "16:20", special: false},
                    {time: "16:40", special: false},
                    {time: "17:00", special: false},
                    {time: "17:20", special: false},
                    {time: "17:40", special: false},
                    {time: "18:00", special: false},
                    {time: "18:20", special: false},
                    {time: "18:40", special: false},
                    {time: "19:00", special: false},
                    {time: "19:20", special: false},
                    {time: "19:40", special: false},
                    {time: "20:00", special: false},
                    {time: "20:20", special: true},
                    {time: "20:40", special: true},
                    {time: "21:00", special: true},
                    {time: "21:20", special: true},
                    {time: "21:40", special: true},
                    {time: "22:10", special: true},
                    {time: "22:40", special: true}
                ],
                "weekend": [
                    {time: "06:15", special: true},
                    {time: "06:35", special: true},
                    {time: "07:00", special: false},
                    {time: "07:20", special: false},
                    {time: "07:40", special: false},
                    {time: "08:00", special: false},
                    {time: "08:20", special: false},
                    {time: "08:40", special: false},
                    {time: "09:00", special: false},
                    {time: "09:20", special: false},
                    {time: "09:40", special: false},
                    {time: "10:00", special: false},
                    {time: "10:20", special: false},
                    {time: "10:40", special: false},
                    {time: "11:00", special: false},
                    {time: "11:20", special: false},
                    {time: "11:40", special: false},
                    {time: "12:00", special: false},
                    {time: "12:20", special: false},
                    {time: "12:40", special: false},
                    {time: "13:00", special: false},
                    {time: "13:20", special: false},
                    {time: "13:40", special: false},
                    {time: "14:00", special: false},
                    {time: "14:20", special: false},
                    {time: "14:40", special: false},
                    {time: "15:00", special: false},
                    {time: "15:20", special: false},
                    {time: "15:40", special: false},
                    {time: "16:00", special: false},
                    {time: "16:20", special: false},
                    {time: "16:40", special: false},
                    {time: "17:00", special: false},
                    {time: "17:20", special: false},
                    {time: "17:40", special: false},
                    {time: "18:00", special: false},
                    {time: "18:20", special: false},
                    {time: "18:40", special: false},
                    {time: "19:00", special: false},
                    {time: "19:20", special: false},
                    {time: "19:40", special: false},
                    {time: "20:00", special: false},
                    {time: "20:20", special: false},
                    {time: "20:40", special: true},
                    {time: "21:00", special: true},
                    {time: "21:20", special: true},
                    {time: "21:40", special: true},
                    {time: "22:10", special: true},
                    {time: "22:40", special: true}
                ]
            }
        };

        const holidays = [
            {date: "2025-01-01", name: "New Year's Day", nameZh: "新年"},
            {date: "2025-01-29", name: "Lunar New Year's Day", nameZh: "農曆新年"},
            {date: "2025-01-30", name: "2nd day of Lunar New Year", nameZh: "農曆新年初二"},
            {date: "2025-01-31", name: "3rd day of Lunar New Year", nameZh: "農曆新年初三"},
            {date: "2025-04-04", name: "Ching Ming Festival", nameZh: "清明節"},
            {date: "2025-04-18", name: "Good Friday", nameZh: "耶穌受難節"},
            {date: "2025-04-19", name: "Day after Good Friday", nameZh: "耶穌受難節翌日"},
            {date: "2025-04-21", name: "Easter Monday", nameZh: "復活節星期一"},
            {date: "2025-05-01", name: "Labor Day", nameZh: "勞動節"},
            {date: "2025-05-05", name: "Buddha's Birthday", nameZh: "佛誕"},
            {date: "2025-05-31", name: "Tuen Ng Festival", nameZh: "端午節"},
            {date: "2025-07-01", name: "HKSAR Day", nameZh: "香港特區成立紀念日"},
            {date: "2025-10-01", name: "National Day", nameZh: "國慶日"},
            {date: "2025-10-07", name: "Mid-Autumn Festival", nameZh: "中秋節翌日"},
            {date: "2025-10-29", name: "Chung Yeung Festival", nameZh: "重陽節"},
            {date: "2025-12-25", name: "Christmas", nameZh: "聖誕節"},
            {date: "2025-12-26", name: "Boxing Day", nameZh: "聖誕節翌日"}
        ];

        const specDesc = {
            "en": {
                "ntp-vr": "Via Sunshine City",
                "vr-ntp": "Via Sunshine City",
                "sc-vr": "Via Villa Concerto", 
                "vr-sc": "Via Villa Concerto"
            },
            "zh": {
                "ntp-vr": "途經新港城",
                "vr-ntp": "途經新港城",
                "sc-vr": "經凱弦居", 
                "vr-sc": "經凱弦居"
            },
            "vc": {
                "en": {
                    "ntp-vc": "Via Sunshine City",
                    "vc-ntp": "Via Sunshine City",
                    "sc-vc": "Via New Town Plaza", 
                    "vc-sc": "Via New Town Plaza"
                },
                "zh": {
                    "ntp-vc": "途經新港城",
                    "vc-ntp": "途經新港城",
                    "sc-vc": "經新城市廣場", 
                    "vc-sc": "經新城市廣場"
                }
            }
        };

        const stopsTxt = {
            "en": {
                "vc": "Stops at Villa Concerto",
                "vr": "Stops at Villa Rhapsody",
                "sc": "Stops at Sunshine City",
                "ntp": "Stops at New Town Plaza"
            },
            "zh": {
                "vc": "途經凱弦居",
                "vr": "途經凱琴居",
                "sc": "途經新港城",
                "ntp": "途經新城市廣場"
            }
        };

        const dayTxt = {
            "en": {
                "weekday": "Weekday",
                "saturday": "Saturday",
                "sunday": "Sunday",
                "holiday": "Public Holiday"
            },
            "zh": {
                "weekday": "平日",
                "saturday": "星期六",
                "sunday": "星期日",
                "holiday": "公眾假期"
            }
        };

        let s = {
            lang: 'en',
            searchVR: '',
            searchVC: '',
            lastUpdate: 0,
            mode: 'current',
            estate: 'vr'
        };
        
        let animID = null;
        
        D.tabCur.addEventListener('click', () => {
            if (s.mode !== 'current') {
                D.tabCur.classList.add('active');
                D.tabSched.classList.remove('active');
                
                if (s.estate === 'vr') {
                    D.curVR.classList.remove('hidden');
                    D.schedVR.classList.add('hidden');
                } else {
                    D.curVC.classList.remove('hidden');
                    D.schedVC.classList.add('hidden');
                }
                
                s.mode = 'current';
                updateBuses();
            }
        });
        
        D.tabSched.addEventListener('click', () => {
            if (s.mode !== 'schedule') {
                D.tabSched.classList.add('active');
                D.tabCur.classList.remove('active');
                
                if (s.estate === 'vr') {
                    D.schedVR.classList.remove('hidden');
                    D.curVR.classList.add('hidden');
                    render('vr');
                } else {
                    D.schedVC.classList.remove('hidden');
                    D.curVC.classList.add('hidden');
                    render('vc');
                }
                
                s.mode = 'schedule';
            }
        });
        
        D.vrTog.addEventListener('click', () => {
            if (s.estate !== 'vr') {
                s.estate = 'vr';
                D.vrTog.classList.add('active');
                D.vcTog.classList.remove('active');
                D.vrView.classList.remove('hidden');
                D.vcView.classList.add('hidden');
                
                if (s.mode === 'current') {
                    D.curVR.classList.remove('hidden');
                    D.schedVR.classList.add('hidden');
                } else {
                    D.schedVR.classList.remove('hidden');
                    D.curVR.classList.add('hidden');
                    render('vr');
                }
                
                updateBuses();
            }
        });
        
        D.vcTog.addEventListener('click', () => {
            if (s.estate !== 'vc') {
                s.estate = 'vc';
                D.vcTog.classList.add('active');
                D.vrTog.classList.remove('active');
                D.vcView.classList.remove('hidden');
                D.vrView.classList.add('hidden');
                
                if (s.mode === 'current') {
                    D.curVC.classList.remove('hidden');
                    D.schedVC.classList.add('hidden');
                } else {
                    D.schedVC.classList.remove('hidden');
                    D.curVC.classList.add('hidden');
                    render('vc');
                }
                
                updateBuses();
            }
        });
        
        D.routeSelVR.addEventListener('change', () => render('vr'));
        D.daySelVR.addEventListener('change', () => render('vr'));
        
        D.searchVR.addEventListener('input', (e) => {
            s.searchVR = e.target.value.trim();
            render('vr');
        });
        
        D.clearVR.addEventListener('click', () => {
            s.searchVR = '';
            D.searchVR.value = '';
            render('vr');
        });
        
        D.routeSelVC.addEventListener('change', () => render('vc'));
        D.daySelVC.addEventListener('change', () => render('vc'));
        
        D.searchVC.addEventListener('input', (e) => {
            s.searchVC = e.target.value.trim();
            render('vc');
        });
        
        D.clearVC.addEventListener('click', () => {
            s.searchVC = '';
            D.searchVC.value = '';
            render('vc');
        });
        
        D.enTog.addEventListener('click', () => {
            if (s.lang !== 'en') {
                s.lang = 'en';
                D.enTog.classList.add('active');
                D.zhTog.classList.remove('active');
                updateLang();
                updateDateTime();
            }
        });
        
        D.zhTog.addEventListener('click', () => {
            if (s.lang !== 'zh') {
                s.lang = 'zh';
                D.zhTog.classList.add('active');
                D.enTog.classList.remove('active');
                updateLang();
                updateDateTime();
            }
        });
        
        function updateLang() {
            document.querySelectorAll('[data-en]').forEach(el => {
                el.textContent = el.getAttribute(`data-${s.lang}`);
            });
            
            document.querySelectorAll('[data-placeholder-en]').forEach(el => {
                el.placeholder = el.getAttribute(`data-placeholder-${s.lang}`);
            });
            
            [D.routeSelVR, D.routeSelVC].forEach(sel => {
                sel.querySelectorAll('option').forEach(op => {
                    op.textContent = op.getAttribute(`data-${s.lang}`);
                });
            });
            
            [D.daySelVR, D.daySelVC].forEach(sel => {
                sel.querySelectorAll('option').forEach(op => {
                    op.textContent = op.getAttribute(`data-${s.lang}`);
                });
            });
            
            updateBuses();
            
            if (s.mode === 'schedule') {
                render(s.estate);
            }
            
            updateDayType();
        }
        
        function fmtDate(date, lang) {
            if (lang === 'en') {
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                return date.toLocaleDateString('en-US', options);
            } else {
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const weekday = ['日', '一', '二', '三', '四', '五', '六'][date.getDay()];
                
                return `${year}年${month}月${day}日 星期${weekday}`;
            }
        }
        
        function getHoliday(date) {
            const ds = date.toISOString().slice(0, 10);
            const h = holidays.find(h => h.date === ds);
            
            if (h) {
                return {
                    isHoliday: true,
                    name: s.lang === 'en' ? h.name : h.nameZh
                };
            }
            
            return { isHoliday: false, name: '' };
        }
        
        function updateDateTime() {
            const now = new Date();
            
            D.curDate.textContent = fmtDate(now, s.lang);
            
            const h = now.getHours().toString().padStart(2, '0');
            const m = now.getMinutes().toString().padStart(2, '0');
            const ss = now.getSeconds().toString().padStart(2, '0');
            
            D.hours.textContent = h;
            D.minutes.textContent = m;
            D.seconds.textContent = ss;
            
            updateDayType();
        }
        
        function updateDayType() {
            const now = new Date();
            const dt = getDayType();
            
            D.dayType.textContent = dayTxt[s.lang][dt];
            
            D.dayType.className = 'day-disp';
            if (dt === 'saturday') {
                D.dayType.classList.add('weekend');
            } else if (dt === 'sunday' || dt === 'holiday') {
                D.dayType.classList.add('holiday');
            }
            
            const h = getHoliday(now);
            if (h.isHoliday) {
                D.holidayName.textContent = h.name;
                D.holidayName.classList.remove('hidden');
            } else {
                D.holidayName.classList.add('hidden');
            }
        }
        
        function getDayType() {
            const now = new Date();
            const day = now.getDay();
            
            const h = getHoliday(now);
            if (h.isHoliday) {
                return 'holiday';
            }
            
            if (day === 0) {
                return 'sunday';
            } else if (day === 6) {
                return 'saturday';
            } else {
                return 'weekday';
            }
        }
        
        function isWeekday() {
            const dt = getDayType();
            return dt === 'weekday';
        }
        
        function toMins(t) {
            const [h, m] = t.split(':').map(Number);
            return h * 60 + m;
        }
        
        function getBus(key, estate) {
            const now = new Date();
            const dt = isWeekday() ? "weekday" : "weekend";
            
            const sch = estate === 'vr' ? schVR : schVC;
            const schedule = sch[key][dt];
            
            const h = now.getHours();
            const m = now.getMinutes();
            const s = now.getSeconds();
            const curMins = h * 60 + m + (s / 60);
            
            let nextIdx = -1;
            let prevIdx = -1;
            
            for (let i = 0; i < schedule.length; i++) {
                const busMins = toMins(schedule[i].time);
                
                if (busMins > curMins) {
                    nextIdx = i;
                    prevIdx = i > 0 ? i - 1 : schedule.length - 1;
                    break;
                }
            }
            
            if (nextIdx === -1) {
                nextIdx = 0;
                prevIdx = schedule.length - 1;
            }
            
            const next = schedule[nextIdx];
            const prev = schedule[prevIdx];
            
            const nextMins = toMins(next.time);
            let until;
            let tmrw = false;
            
            if (nextMins > curMins) {
                until = nextMins - curMins;
            } else {
                until = (24 * 60 - curMins) + nextMins;
                tmrw = true;
            }
            
            const prevMins = toMins(prev.time);
            let total;
            let elapsed;
            
            if (prevMins < nextMins && !tmrw) {
                total = nextMins - prevMins;
                elapsed = curMins - prevMins;
            } else if (tmrw) {
                total = (24 * 60 - prevMins) + nextMins;
                elapsed = curMins - prevMins;
                if (elapsed < 0) {
                    elapsed += 24 * 60;
                }
            } else {
                total = nextMins + (24 * 60 - prevMins);
                elapsed = curMins + (24 * 60 - prevMins);
            }
            
            const prog = Math.min(100, Math.max(0, (elapsed / total) * 100));
            
            let interVia = null;
            if (interRoutes[estate] && interRoutes[estate][key]) {
                interVia = interRoutes[estate][key];
            }
            
            let specVia = null;
            if (next.special && specVia && specVia[estate] && specVia[estate][key]) {
                specVia = specVia[estate][key];
            }
            
            return {
                next,
                prev,
                until,
                prog,
                tmrw,
                interVia,
                specVia
            };
        }
        
        function fmtMins(mins) {
            const total = Math.floor(mins);
            const s = Math.floor((mins - total) * 60);
            
            if (total < 60) {
                return `${total} min ${s} sec`;
            } else {
                const h = Math.floor(total / 60);
                const m = total % 60;
                return `${h} hr ${m} min ${s} sec`;
            }
        }
        
        function updateBusDisplay(key, el, estate) {
            const bus = getBus(key, estate);
            const next = bus.next;
            
            el.time.textContent = next.time;
            if (next.special) {
                el.time.classList.add('special');
                
                const desc = estate === 'vr' 
                    ? specDesc[s.lang][key]
                    : specDesc.vc[s.lang][key];
                
                el.note.textContent = s.lang === 'en' 
                    ? "Special Run - " + desc
                    : "特別班次 - " + desc;
            } else {
                el.time.classList.remove('special');
                el.note.textContent = "";
            }
            
            // Set stops information in the stops note element
            if (bus.interVia) {
                el.stops.textContent = stopsTxt[s.lang][bus.interVia];
                el.stops.classList.remove('hidden');
            } else {
                el.stops.textContent = "";
                el.stops.classList.add('hidden');
            }
            
            // Add special via info if available
            if (next.special && key in specVia[estate]) {
                const viaPlace = specVia[estate][key];
                const stopMsg = stopsTxt[s.lang][viaPlace];
                el.stops.textContent = stopMsg;
                el.stops.classList.remove('hidden');
            }
            
            const cdText = bus.tmrw 
                ? (s.lang === 'en' ? 
                   `Arriving tomorrow in ${fmtMins(bus.until)}` :
                   `明天到達，還剩 ${fmtMins(bus.until)}`)
                : (s.lang === 'en' ? 
                   `Arriving in ${fmtMins(bus.until)}` :
                   `到達時間剩餘 ${fmtMins(bus.until)}`);
            el.cdown.textContent = cdText;
            
            el.prog.style.width = bus.prog + '%';
            
            return {
                bus: next,
                interVia: bus.interVia
            };
        }
        
        function updateBuses() {
            const now = Date.now();
            s.lastUpdate = now;
            
            if (s.mode !== 'current') return;
            
            if (s.estate === 'vr') {
                updateBusDisplay('ntp-vr', D.nextNTPVR, 'vr');
                updateBusDisplay('vr-ntp', D.nextVRNTP, 'vr');
                updateBusDisplay('sc-vr', D.nextSCVR, 'vr');
                updateBusDisplay('vr-sc', D.nextVRSC, 'vr');
            } else {
                updateBusDisplay('ntp-vc', D.nextNTPVC, 'vc');
                updateBusDisplay('vc-ntp', D.nextVCNTP, 'vc');
                updateBusDisplay('sc-vc', D.nextSCVC, 'vc');
                updateBusDisplay('vc-sc', D.nextVCSC, 'vc');
            }
        }
        
        function filterTimes(times, search) {
            if (!search) return times;
            return times.filter(b => b.time.includes(search));
        }
        
        function render(estate) {
            if (s.mode !== 'schedule') return;
            
            const dom = estate === 'vr' 
                ? {
                    routeSel: D.routeSelVR,
                    daySel: D.daySelVR,
                    grid: D.gridVR,
                    title: D.schedTitleVR
                }
                : {
                    routeSel: D.routeSelVC,
                    daySel: D.daySelVC,
                    grid: D.gridVC,
                    title: D.schedTitleVC
                };
                
            const search = estate === 'vr' ? s.searchVR : s.searchVC;
            const sch = estate === 'vr' ? schVR : schVC;
            
            const key = dom.routeSel.value;
            const dayType = dom.daySel.value;
            const schedule = sch[key][dayType];
            
            dom.title.textContent = dom.routeSel.options[dom.routeSel.selectedIndex].textContent;
            
            const filtered = filterTimes(schedule, search);
            
            dom.grid.innerHTML = '';
            
            const now = new Date();
            const curDayType = isWeekday() ? "weekday" : "weekend";
            let nextTime = null;
            
            if (curDayType === dayType) {
                const bus = getBus(key, estate);
                nextTime = bus.next.time;
            }
            
            const isInter = interRoutes[estate] && interRoutes[estate][key];
            
            const frag = document.createDocumentFragment();
            
            filtered.forEach(bus => {
                const cell = document.createElement('div');
                cell.textContent = bus.time;
                cell.classList.add('time-cell');
                
                if (bus.special) {
                    cell.classList.add('special');
                }
                
                if (bus.time === nextTime && curDayType === dayType) {
                    cell.classList.add('next');
                }
                
                if (isInter) {
                    cell.classList.add('inter');
                }
                
                if (search && bus.time.includes(search)) {
                    cell.classList.add('highlight');
                }
                
                frag.appendChild(cell);
            });
            
            dom.grid.appendChild(frag);
        }
        
        function updateUI() {
            if (animID) {
                cancelAnimationFrame(animID);
            }
            
            updateDateTime();
            updateBuses();
            
            if (s.mode === 'schedule' && Math.random() < 0.1) {
                render(s.estate);
            }
            
            animID = requestAnimationFrame(() => {
                setTimeout(updateUI, 1000);
            });
        }
        
        function savePrefs() {
            try {
                localStorage.setItem('busPrefs', JSON.stringify({
                    lang: s.lang,
                    estate: s.estate
                }));
            } catch (e) {
                console.log('Save error:', e);
            }
        }
        
        function loadPrefs() {
            try {
                const p = JSON.parse(localStorage.getItem('busPrefs'));
                if (p) {
                    if (p.lang === 'zh') {
                        D.zhTog.click();
                    } else {
                        D.enTog.click();
                    }
                    
                    if (p.estate === 'vc') {
                        D.vcTog.click();
                    } else {
                        D.vrTog.click();
                    }
                }
            } catch (e) {
                console.log('Load error:', e);
            }
        }
        
        function init() {
            loadPrefs();
            updateUI();
            
            const isWkday = isWeekday();
            D.daySelVR.value = isWkday ? "weekday" : "weekend";
            D.daySelVC.value = isWkday ? "weekday" : "weekend";
            
            D.tabCur.click();
            window.addEventListener('beforeunload', savePrefs);
        }
        
        init();
    </script>
</body>
</html>
