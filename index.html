<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Villa Rhapsody Bus Schedule</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            /* Light theme (default) */
            --primary-color: #3498db;
            --primary-light: rgba(52, 152, 219, 0.2);
            --secondary-color: #2980b9;
            --accent-color: #e74c3c;
            --light-bg: #f5f7fa;
            --text-color: #2c3e50;
            --text-secondary: #7f8c8d;
            --special-run-color: #e67e22;
            --card-bg: white;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --next-bus-border: 3px solid var(--primary-color);
            --special-bg: #fef0e6;
            --input-bg: white;
            --input-border: #ddd;
            --toggle-bg: #ecf0f1;
            --toggle-text: #333;
            --datetime-bg: rgba(52, 152, 219, 0.1);
            --date-text: #2c3e50;
            --time-text: #3498db;
            --holiday-badge: #e74c3c;
        }
        
        /* Dark theme */
        [data-theme="dark"] {
            --primary-color: #2980b9;
            --primary-light: rgba(41, 128, 185, 0.2);
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-bg: #1a1a1a;
            --text-color: #ecf0f1;
            --text-secondary: #bdc3c7;
            --special-run-color: #e67e22;
            --card-bg: #2c2c2c;
            --shadow: 0 2px 10px rgba(0,0,0,0.3);
            --next-bus-border: 3px solid var(--primary-color);
            --special-bg: #4a3319;
            --input-bg: #2c2c2c;
            --input-border: #444;
            --toggle-bg: #444;
            --toggle-text: #ecf0f1;
            --datetime-bg: rgba(41, 128, 185, 0.2);
            --date-text: #ecf0f1;
            --time-text: #3498db;
            --holiday-badge: #e74c3c;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        
        body {
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.6;
            padding: 15px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .title-container {
            margin-bottom: 15px;
        }
        
        h1 {
            color: var(--primary-color);
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .datetime-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            width: 100%;
            max-width: 500px;
        }
        
        .datetime-card {
            background: var(--datetime-bg);
            border-radius: 12px;
            padding: 10px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .date-display {
            font-size: 1rem;
            font-weight: 500;
            color: var(--date-text);
            margin-bottom: 4px;
            width: 100%;
            text-align: center;
        }
        
        .time-display-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            margin-bottom: 6px;
        }
        
        .time-unit {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .time-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--time-text);
            text-align: center;
            min-width: 40px;
            line-height: 1.2;
        }
        
        .time-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .time-separator {
            font-size: 1.8rem;
            color: var(--time-text);
            opacity: 0.5;
            margin: 0 2px;
            line-height: 1.2;
        }
        
        .day-type-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .day-type-display {
            display: inline-block;
            padding: 3px 12px;
            margin-top: 5px;
            border-radius: 15px;
            font-weight: 600;
            background-color: var(--primary-color);
            color: white;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        
        .day-type-display.weekend {
            background-color: var(--accent-color);
        }
        
        .day-type-display.holiday {
            background-color: var(--special-run-color);
        }
        
        .holiday-name {
            font-size: 0.85rem;
            color: var(--holiday-badge);
            font-weight: 600;
            margin-top: 3px;
        }
        
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .tab {
            padding: 10px 20px;
            background-color: var(--toggle-bg);
            color: var(--toggle-text);
            border: none;
            cursor: pointer;
            margin: 3px;
            border-radius: 5px;
            font-weight: 600;
            transition: all 0.3s;
            flex: 1;
            text-align: center;
        }
        
        .tab.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .language-toggle, .theme-toggle {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .top-controls {
            display: flex;
            justify-content: space-between;
            width: 100%;
            padding: 0 15px;
            margin-bottom: 15px;
        }
        
        .language-toggle button, .theme-toggle button {
            padding: 5px 10px;
            background-color: var(--toggle-bg);
            color: var(--toggle-text);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .language-toggle button.active, .theme-toggle button.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .next-buses {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .next-bus-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--shadow);
            flex: 1 1 300px;
            position: relative;
            overflow: hidden;
        }
        
        .next-bus-card h3 {
            color: var(--primary-color);
            margin-bottom: 12px;
            font-size: 1.2rem;
            border-bottom: 2px solid var(--light-bg);
            padding-bottom: 8px;
            font-weight: 600;
        }
        
        .time-display {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--text-color);
            margin: 12px 0;
            text-align: center;
        }
        
        .time-display.special {
            color: var(--special-run-color);
        }
        
        .countdown {
            text-align: center;
            font-size: 1.1rem;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .countdown-bar-container {
            position: relative;
            height: 8px;
            width: 100%;
            background-color: var(--light-bg);
            border-radius: 4px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        .countdown-bar {
            height: 100%;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            border-radius: 4px;
            width: 0%;
            transition: width 1s linear;
        }
        
        .countdown-marker {
            position: absolute;
            top: 50%;
            width: 3px;
            height: 8px;
            background-color: rgba(255, 255, 255, 0.7);
            transform: translateY(-50%);
        }
        
        .special-notice {
            font-size: 0.9rem;
            color: var(--special-run-color);
            margin-top: 8px;
            font-style: italic;
            text-align: center;
        }
        
        .section-title {
            font-size: 1.3rem;
            color: var(--primary-color);
            margin: 20px 0 12px;
            text-align: center;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .section-title::before,
        .section-title::after {
            content: "";
            height: 1px;
            flex-grow: 1;
            background-color: var(--primary-light);
            margin: 0 15px;
        }
        
        .schedule-container {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--shadow);
            margin-top: 15px;
            overflow-x: auto;
        }
        
        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .schedule-title {
            font-size: 1.2rem;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        select, button, input {
            padding: 8px 12px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        input::placeholder {
            color: var(--text-secondary);
            opacity: 0.8;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s;
            font-weight: 600;
        }
        
        button:hover {
            background-color: var(--secondary-color);
        }
        
        .search-container {
            display: flex;
            margin-bottom: 15px;
            width: 100%;
        }
        
        .search-input {
            flex: 1;
            min-width: 0;
            margin-right: 10px;
        }
        
        .clear-search {
            background-color: var(--accent-color);
        }
        
        .time-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .time-cell {
            padding: 10px 8px;
            text-align: center;
            background-color: var(--light-bg);
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            transition: transform 0.2s;
        }
        
        .time-cell:hover {
            transform: translateY(-2px);
        }
        
        .time-cell.special {
            background-color: var(--special-bg);
            color: var(--special-run-color);
            font-weight: 600;
        }
        
        .time-cell.highlight {
            animation: pulse 1s infinite alternate;
        }
        
        @keyframes pulse {
            from { opacity: 1; }
            to { opacity: 0.6; }
        }
        
        /* Fixed: Next bus now uses a border instead of changing the background */
        .time-cell.next {
            border: var(--next-bus-border);
            position: relative;
            box-sizing: border-box;
        }
        
        /* Add a dot indicator for next bus */
        .time-cell.next::after {
            content: "";
            position: absolute;
            top: 3px;
            right: 3px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--primary-color);
        }
        
        .hidden {
            display: none;
        }
        
        .legend {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            justify-content: center;
            flex-wrap: wrap;
            font-size: 0.9rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }
        
        .legend-color.regular {
            background-color: var(--light-bg);
        }
        
        .legend-color.special {
            background-color: var(--special-bg);
        }
        
        /* Update the next bus legend to match the new style */
        .legend-color.next {
            background-color: var(--light-bg);
            border: 2px solid var(--primary-color);
            position: relative;
        }
        
        .legend-color.next::after {
            content: "";
            position: absolute;
            top: 1px;
            right: 1px;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background-color: var(--primary-color);
        }
        
        @media (max-width: 768px) {
            .top-controls {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            
            .theme-toggle {
                order: -1;
            }
            
            .title-container {
                margin-top: 15px;
            }
            
            .schedule-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .schedule-title {
                margin-bottom: 10px;
            }
        }
        
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            .next-bus-card {
                flex: 1 1 100%;
            }
            
            .time-grid {
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            }
            
            .search-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .search-input {
                margin-right: 0;
                margin-bottom: 10px;
            }
            
            .time-display-container {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="top-controls">
            <div class="language-toggle">
                <button id="en-toggle" class="active">English</button>
                <button id="zh-toggle">中文</button>
            </div>
            
            <div class="theme-toggle">
                <button id="light-toggle" class="active" data-en="Light" data-zh="淺色">Light</button>
                <button id="dark-toggle" data-en="Dark" data-zh="深色">Dark</button>
            </div>
        </div>
        
        <div class="title-container">
            <h1 data-en="Villa Rhapsody Bus Schedule" data-zh="凱琴居巴士時間表">Villa Rhapsody Bus Schedule</h1>
        </div>
        
        <div class="datetime-container">
            <div class="datetime-card">
                <div class="date-display" id="current-date"></div>
                <div class="time-display-container" id="current-time">
                    <div class="time-unit">
                        <div class="time-value" id="hours">00</div>
                        <div class="time-label" data-en="Hours" data-zh="時">Hours</div>
                    </div>
                    <div class="time-separator">:</div>
                    <div class="time-unit">
                        <div class="time-value" id="minutes">00</div>
                        <div class="time-label" data-en="Minutes" data-zh="分">Minutes</div>
                    </div>
                    <div class="time-separator">:</div>
                    <div class="time-unit">
                        <div class="time-value" id="seconds">00</div>
                        <div class="time-label" data-en="Seconds" data-zh="秒">Seconds</div>
                    </div>
                </div>
                <div class="day-type-container">
                    <div class="day-type-display" id="day-type">Weekday</div>
                    <div class="holiday-name hidden" id="holiday-name"></div>
                </div>
            </div>
        </div>
    </header>
    
    <div class="tabs">
        <button class="tab active" id="tab-current" data-en="Next Buses" data-zh="下一班車">Next Buses</button>
        <button class="tab" id="tab-schedule" data-en="Full Schedule" data-zh="完整時間表">Full Schedule</button>
    </div>
    
    <div id="current-view">
        <div class="section-title" data-en="Main Route" data-zh="主線">Main Route</div>
        <div class="next-buses">
            <div class="next-bus-card">
                <h3 data-en="From New Town Plaza to Villa Rhapsody" data-zh="由沙田新城市廣場往凱琴居">From New Town Plaza to Villa Rhapsody</h3>
                <div class="time-display" id="next-ntp-to-vr">--:--</div>
                <div class="countdown" id="countdown-ntp-to-vr">Loading...</div>
                <div class="countdown-bar-container">
                    <div class="countdown-bar" id="progress-ntp-to-vr"></div>
                </div>
                <div class="special-notice" id="special-notice-ntp-to-vr"></div>
            </div>
            
            <div class="next-bus-card">
                <h3 data-en="From Villa Rhapsody to New Town Plaza" data-zh="由凱琴居往沙田新城市廣場">From Villa Rhapsody to New Town Plaza</h3>
                <div class="time-display" id="next-vr-to-ntp">--:--</div>
                <div class="countdown" id="countdown-vr-to-ntp">Loading...</div>
                <div class="countdown-bar-container">
                    <div class="countdown-bar" id="progress-vr-to-ntp"></div>
                </div>
                <div class="special-notice" id="special-notice-vr-to-ntp"></div>
            </div>
        </div>
        
        <div class="section-title" data-en="Short Route" data-zh="短途線">Short Route</div>
        <div class="next-buses">
            <div class="next-bus-card">
                <h3 data-en="From Sunshine City to Villa Rhapsody" data-zh="由馬鞍山新港城往凱琴居">From Sunshine City to Villa Rhapsody</h3>
                <div class="time-display" id="next-sc-to-vr">--:--</div>
                <div class="countdown" id="countdown-sc-to-vr">Loading...</div>
                <div class="countdown-bar-container">
                    <div class="countdown-bar" id="progress-sc-to-vr"></div>
                </div>
                <div class="special-notice" id="special-notice-sc-to-vr"></div>
            </div>
            
            <div class="next-bus-card">
                <h3 data-en="From Villa Rhapsody to Sunshine City" data-zh="由凱琴居往馬鞍山新港城">From Villa Rhapsody to Sunshine City</h3>
                <div class="time-display" id="next-vr-to-sc">--:--</div>
                <div class="countdown" id="countdown-vr-to-sc">Loading...</div>
                <div class="countdown-bar-container">
                    <div class="countdown-bar" id="progress-vr-to-sc"></div>
                </div>
                <div class="special-notice" id="special-notice-vr-to-sc"></div>
            </div>
        </div>
    </div>
    
    <div id="schedule-view" class="hidden">
        <div class="schedule-container">
            <div class="schedule-header">
                <div class="schedule-title" id="schedule-title">Bus Schedule</div>
                <div class="controls">
                    <select id="route-select">
                        <option value="ntp-to-vr" data-en="New Town Plaza to Villa Rhapsody (Main Route)" data-zh="由沙田新城市廣場往凱琴居 (主線)">New Town Plaza to Villa Rhapsody (Main Route)</option>
                        <option value="vr-to-ntp" data-en="Villa Rhapsody to New Town Plaza (Main Route)" data-zh="由凱琴居往沙田新城市廣場 (主線)">Villa Rhapsody to New Town Plaza (Main Route)</option>
                        <option value="sc-to-vr" data-en="Sunshine City to Villa Rhapsody (Short Route)" data-zh="由馬鞍山新港城往凱琴居 (短途線)">Sunshine City to Villa Rhapsody (Short Route)</option>
                        <option value="vr-to-sc" data-en="Villa Rhapsody to Sunshine City (Short Route)" data-zh="由凱琴居往馬鞍山新港城 (短途線)">Villa Rhapsody to Sunshine City (Short Route)</option>
                    </select>
                    <select id="day-select">
                        <option value="weekday" data-en="Monday to Friday" data-zh="星期一至星期五">Monday to Friday</option>
                        <option value="weekend" data-en="Saturday, Sunday & Public Holiday" data-zh="星期六/日及公眾假期">Saturday, Sunday & Public Holiday</option>
                    </select>
                </div>
            </div>
            
            <div class="search-container">
                <input type="text" id="time-search" class="search-input" placeholder="Search time (e.g. 08:30)" data-placeholder-en="Search time (e.g. 08:30)" data-placeholder-zh="搜尋時間 (例如 08:30)">
                <button id="clear-search" class="clear-search" data-en="Clear" data-zh="清除">Clear</button>
            </div>
            
            <div class="time-grid" id="time-grid">
                <!-- Times will be filled in by JavaScript -->
            </div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color regular"></div>
                    <span data-en="Regular Service" data-zh="正常班次">Regular Service</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color special"></div>
                    <span data-en="Special Run" data-zh="特別班次">Special Run</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color next"></div>
                    <span data-en="Next Bus" data-zh="下一班車">Next Bus</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Performance optimization: Store DOM references outside functions
        const DOM = {
            // Tabs and view elements
            tabCurrent: document.getElementById('tab-current'),
            tabSchedule: document.getElementById('tab-schedule'),
            currentView: document.getElementById('current-view'),
            scheduleView: document.getElementById('schedule-view'),
            
            // Route and day controls
            routeSelect: document.getElementById('route-select'),
            daySelect: document.getElementById('day-select'),
            timeGrid: document.getElementById('time-grid'),
            scheduleTitle: document.getElementById('schedule-title'),
            
            // Search elements
            timeSearch: document.getElementById('time-search'),
            clearSearch: document.getElementById('clear-search'),
            
            // Next bus elements - Main Route
            nextNTPtoVR: {
                time: document.getElementById('next-ntp-to-vr'),
                countdown: document.getElementById('countdown-ntp-to-vr'),
                progress: document.getElementById('progress-ntp-to-vr'),
                notice: document.getElementById('special-notice-ntp-to-vr')
            },
            nextVRtoNTP: {
                time: document.getElementById('next-vr-to-ntp'),
                countdown: document.getElementById('countdown-vr-to-ntp'),
                progress: document.getElementById('progress-vr-to-ntp'),
                notice: document.getElementById('special-notice-vr-to-ntp')
            },
            
            // Next bus elements - Short Route
            nextSCtoVR: {
                time: document.getElementById('next-sc-to-vr'),
                countdown: document.getElementById('countdown-sc-to-vr'),
                progress: document.getElementById('progress-sc-to-vr'),
                notice: document.getElementById('special-notice-sc-to-vr')
            },
            nextVRtoSC: {
                time: document.getElementById('next-vr-to-sc'),
                countdown: document.getElementById('countdown-vr-to-sc'),
                progress: document.getElementById('progress-vr-to-sc'),
                notice: document.getElementById('special-notice-vr-to-sc')
            },
            
            // Theme and language toggles
            enToggle: document.getElementById('en-toggle'),
            zhToggle: document.getElementById('zh-toggle'),
            lightToggle: document.getElementById('light-toggle'),
            darkToggle: document.getElementById('dark-toggle'),
            
            // Date and time display
            currentDate: document.getElementById('current-date'),
            hoursEl: document.getElementById('hours'),
            minutesEl: document.getElementById('minutes'),
            secondsEl: document.getElementById('seconds'),
            dayType: document.getElementById('day-type'),
            holidayName: document.getElementById('holiday-name')
        };

        // Bus schedule data
        const busSchedules = {
            // MAIN ROUTE
            "ntp-to-vr": { // New Town Plaza to Villa Rhapsody
                "weekday": [
                    {time: "06:35", special: false},
                    {time: "06:50", special: false},
                    {time: "07:00", special: false},
                    {time: "07:15", special: false},
                    {time: "07:25", special: false},
                    {time: "07:35", special: false},
                    {time: "07:50", special: false},
                    {time: "08:00", special: false},
                    {time: "08:10", special: false},
                    {time: "08:25", special: false},
                    {time: "08:35", special: false},
                    {time: "08:45", special: false},
                    {time: "09:00", special: false},
                    {time: "09:15", special: false},
                    {time: "09:35", special: false},
                    {time: "09:55", special: false},
                    {time: "10:15", special: false},
                    {time: "10:35", special: false},
                    {time: "10:55", special: false},
                    {time: "11:15", special: false},
                    {time: "11:35", special: false},
                    {time: "11:55", special: false},
                    {time: "12:15", special: false},
                    {time: "12:35", special: false},
                    {time: "12:55", special: false},
                    {time: "13:15", special: false},
                    {time: "13:45", special: true},
                    {time: "14:20", special: false},
                    {time: "14:45", special: true},
                    {time: "15:20", special: false},
                    {time: "15:35", special: false},
                    {time: "15:55", special: false},
                    {time: "16:15", special: false},
                    {time: "16:30", special: false},
                    {time: "16:45", special: false},
                    {time: "17:00", special: false},
                    {time: "17:15", special: false},
                    {time: "17:30", special: false},
                    {time: "17:45", special: false},
                    {time: "18:00", special: false},
                    {time: "18:15", special: false},
                    {time: "18:30", special: false},
                    {time: "18:45", special: false},
                    {time: "19:00", special: false},
                    {time: "19:15", special: false},
                    {time: "19:30", special: false},
                    {time: "19:45", special: false},
                    {time: "20:00", special: true},
                    {time: "20:15", special: true},
                    {time: "20:40", special: true},
                    {time: "21:00", special: true},
                    {time: "21:20", special: true},
                    {time: "21:40", special: true},
                    {time: "22:00", special: true},
                    {time: "22:30", special: true},
                    {time: "23:00", special: true}
                ],
                "weekend": [
                    {time: "06:35", special: false},
                    {time: "06:55", special: false},
                    {time: "07:15", special: false},
                    {time: "07:35", special: false},
                    {time: "07:55", special: false},
                    {time: "08:15", special: false},
                    {time: "08:30", special: false},
                    {time: "08:45", special: false},
                    {time: "09:00", special: false},
                    {time: "09:15", special: false},
                    {time: "09:35", special: false},
                    {time: "09:55", special: false},
                    {time: "10:15", special: false},
                    {time: "10:35", special: false},
                    {time: "10:55", special: false},
                    {time: "11:15", special: false},
                    {time: "11:35", special: false},
                    {time: "11:55", special: false},
                    {time: "12:15", special: false},
                    {time: "12:35", special: false},
                    {time: "12:55", special: false},
                    {time: "13:15", special: false},
                    {time: "13:35", special: false},
                    {time: "13:55", special: false},
                    {time: "14:15", special: false},
                    {time: "14:35", special: false},
                    {time: "14:55", special: false},
                    {time: "15:15", special: false},
                    {time: "15:35", special: false},
                    {time: "15:55", special: false},
                    {time: "16:15", special: false},
                    {time: "16:30", special: false},
                    {time: "16:45", special: false},
                    {time: "17:00", special: false},
                    {time: "17:15", special: false},
                    {time: "17:30", special: false},
                    {time: "17:45", special: false},
                    {time: "18:00", special: false},
                    {time: "18:15", special: false},
                    {time: "18:30", special: false},
                    {time: "18:45", special: false},
                    {time: "19:00", special: false},
                    {time: "19:15", special: false},
                    {time: "19:30", special: false},
                    {time: "19:45", special: false},
                    {time: "20:00", special: false},
                    {time: "20:15", special: false},
                    {time: "20:35", special: true},
                    {time: "21:00", special: true},
                    {time: "21:20", special: true},
                    {time: "21:40", special: true},
                    {time: "22:00", special: true},
                    {time: "22:30", special: true},
                    {time: "23:00", special: true}
                ]
            },
            "vr-to-ntp": { // Villa Rhapsody to New Town Plaza
                "weekday": [
                    {time: "06:16", special: true},
                    {time: "06:31", special: true},
                    {time: "06:41", special: true},
                    {time: "07:01", special: false},
                    {time: "07:11", special: false},
                    {time: "07:21", special: false},
                    {time: "07:36", special: false},
                    {time: "07:46", special: false},
                    {time: "07:56", special: false},
                    {time: "08:11", special: false},
                    {time: "08:21", special: false},
                    {time: "08:31", special: false},
                    {time: "08:46", special: false},
                    {time: "09:01", special: false},
                    {time: "09:21", special: false},
                    {time: "09:41", special: false},
                    {time: "10:01", special: false},
                    {time: "10:21", special: false},
                    {time: "10:41", special: false},
                    {time: "11:01", special: false},
                    {time: "11:21", special: false},
                    {time: "11:41", special: false},
                    {time: "12:01", special: false},
                    {time: "12:21", special: false},
                    {time: "12:41", special: false},
                    {time: "13:01", special: false},
                    {time: "13:31", special: false},
                    {time: "14:01", special: true},
                    {time: "14:30", special: false},
                    {time: "15:01", special: true},
                    {time: "15:21", special: false},
                    {time: "15:41", special: false},
                    {time: "16:01", special: false},
                    {time: "16:11", special: false},
                    {time: "16:31", special: false},
                    {time: "16:46", special: false},
                    {time: "17:01", special: false},
                    {time: "17:16", special: false},
                    {time: "17:31", special: false},
                    {time: "17:46", special: false},
                    {time: "18:01", special: false},
                    {time: "18:16", special: false},
                    {time: "18:31", special: false},
                    {time: "18:46", special: false},
                    {time: "19:01", special: false},
                    {time: "19:16", special: false},
                    {time: "19:31", special: false},
                    {time: "19:46", special: false},
                    {time: "20:01", special: false},
                    {time: "20:21", special: true},
                    {time: "20:41", special: true},
                    {time: "21:01", special: true},
                    {time: "21:21", special: true},
                    {time: "21:41", special: true},
                    {time: "22:11", special: true},
                    {time: "22:41", special: true}
                ],
                "weekend": [
                    {time: "06:16", special: true},
                    {time: "06:36", special: true},
                    {time: "07:01", special: false},
                    {time: "07:21", special: false},
                    {time: "07:41", special: false},
                    {time: "08:01", special: false},
                    {time: "08:16", special: false},
                    {time: "08:31", special: false},
                    {time: "08:46", special: false},
                    {time: "09:01", special: false},
                    {time: "09:21", special: false},
                    {time: "09:41", special: false},
                    {time: "10:01", special: false},
                    {time: "10:21", special: false},
                    {time: "10:41", special: false},
                    {time: "11:01", special: false},
                    {time: "11:21", special: false},
                    {time: "11:41", special: false},
                    {time: "12:01", special: false},
                    {time: "12:21", special: false},
                    {time: "12:41", special: false},
                    {time: "13:01", special: false},
                    {time: "13:21", special: false},
                    {time: "13:41", special: false},
                    {time: "14:01", special: false},
                    {time: "14:21", special: false},
                    {time: "14:41", special: false},
                    {time: "15:01", special: false},
                    {time: "15:21", special: false},
                    {time: "15:41", special: false},
                    {time: "16:01", special: false},
                    {time: "16:16", special: false},
                    {time: "16:31", special: false},
                    {time: "16:46", special: false},
                    {time: "17:01", special: false},
                    {time: "17:16", special: false},
                    {time: "17:31", special: false},
                    {time: "17:46", special: false},
                    {time: "18:01", special: false},
                    {time: "18:16", special: false},
                    {time: "18:31", special: false},
                    {time: "18:46", special: false},
                    {time: "19:01", special: false},
                    {time: "19:16", special: false},
                    {time: "19:31", special: false},
                    {time: "19:46", special: false},
                    {time: "20:01", special: false},
                    {time: "20:21", special: false},
                    {time: "20:41", special: true},
                    {time: "21:01", special: true},
                    {time: "21:21", special: true},
                    {time: "21:41", special: true},
                    {time: "22:11", special: true},
                    {time: "22:41", special: true}
                ]
            },
            
            // SHORT ROUTE
            "sc-to-vr": { // Sunshine City to Villa Rhapsody
                "weekday": [
                    {time: "07:10", special: false},
                    {time: "07:22", special: false},
                    {time: "07:27", special: false},
                    {time: "07:37", special: false},
                    {time: "07:47", special: false},
                    {time: "07:57", special: false},
                    {time: "08:07", special: false},
                    {time: "08:17", special: false},
                    {time: "08:27", special: false},
                    {time: "08:37", special: false},
                    {time: "08:47", special: false},
                    {time: "08:57", special: false},
                    {time: "09:10", special: false},
                    {time: "09:30", special: false},
                    {time: "09:50", special: false},
                    {time: "10:10", special: false},
                    {time: "10:30", special: false},
                    {time: "10:50", special: false},
                    {time: "11:10", special: false},
                    {time: "11:30", special: false},
                    {time: "11:50", special: false},
                    {time: "12:10", special: false},
                    {time: "12:30", special: false},
                    {time: "12:50", special: false},
                    {time: "13:10", special: false},
                    {time: "13:30", special: false},
                    {time: "13:50", special: false},
                    {time: "14:00", special: true},
                    {time: "14:30", special: false},
                    {time: "14:50", special: false},
                    {time: "15:00", special: true},
                    {time: "15:30", special: false},
                    {time: "15:50", special: false},
                    {time: "16:10", special: false},
                    {time: "16:30", special: false},
                    {time: "16:50", special: false},
                    {time: "17:10", special: false},
                    {time: "17:30", special: false},
                    {time: "17:50", special: false},
                    {time: "18:10", special: false},
                    {time: "18:30", special: false},
                    {time: "18:50", special: false},
                    {time: "19:10", special: false},
                    {time: "19:30", special: false},
                    {time: "19:50", special: false},
                    {time: "20:10", special: false},
                    {time: "20:15", special: true},
                    {time: "20:30", special: true},
                    {time: "20:55", special: true},
                    {time: "21:15", special: true},
                    {time: "21:35", special: true},
                    {time: "21:55", special: true},
                    {time: "22:15", special: true},
                    {time: "22:45", special: true},
                    {time: "23:15", special: true}
                ],
                "weekend": [
                    {time: "07:10", special: false},
                    {time: "07:30", special: false},
                    {time: "07:50", special: false},
                    {time: "08:10", special: false},
                    {time: "08:30", special: false},
                    {time: "08:50", special: false},
                    {time: "09:10", special: false},
                    {time: "09:30", special: false},
                    {time: "09:50", special: false},
                    {time: "10:10", special: false},
                    {time: "10:30", special: false},
                    {time: "10:50", special: false},
                    {time: "11:10", special: false},
                    {time: "11:30", special: false},
                    {time: "11:50", special: false},
                    {time: "12:10", special: false},
                    {time: "12:30", special: false},
                    {time: "12:50", special: false},
                    {time: "13:10", special: false},
                    {time: "13:30", special: false},
                    {time: "13:50", special: false},
                    {time: "14:10", special: false},
                    {time: "14:30", special: false},
                    {time: "14:50", special: false},
                    {time: "15:10", special: false},
                    {time: "15:30", special: false},
                    {time: "15:50", special: false},
                    {time: "16:10", special: false},
                    {time: "16:30", special: false},
                    {time: "16:50", special: false},
                    {time: "17:10", special: false},
                    {time: "17:30", special: false},
                    {time: "17:50", special: false},
                    {time: "18:10", special: false},
                    {time: "18:30", special: false},
                    {time: "18:50", special: false},
                    {time: "19:10", special: false},
                    {time: "19:30", special: false},
                    {time: "19:50", special: false},
                    {time: "20:10", special: false},
                    {time: "20:30", special: false},
                    {time: "20:50", special: true},
                    {time: "21:15", special: true},
                    {time: "21:35", special: true},
                    {time: "21:55", special: true},
                    {time: "22:15", special: true},
                    {time: "22:45", special: true},
                    {time: "23:15", special: true}
                ]
            },
            "vr-to-sc": { // Villa Rhapsody to Sunshine City
                "weekday": [
                    {time: "06:16", special: true},
                    {time: "06:31", special: true},
                    {time: "06:41", special: true},
                    {time: "07:00", special: false},
                    {time: "07:15", special: false},
                    {time: "07:20", special: false},
                    {time: "07:30", special: false},
                    {time: "07:40", special: false},
                    {time: "07:50", special: false},
                    {time: "08:00", special: false},
                    {time: "08:10", special: false},
                    {time: "08:20", special: false},
                    {time: "08:30", special: false},
                    {time: "08:40", special: false},
                    {time: "08:50", special: false},
                    {time: "09:00", special: false},
                    {time: "09:20", special: false},
                    {time: "09:40", special: false},
                    {time: "10:00", special: false},
                    {time: "10:20", special: false},
                    {time: "10:40", special: false},
                    {time: "11:00", special: false},
                    {time: "11:20", special: false},
                    {time: "11:40", special: false},
                    {time: "12:00", special: false},
                    {time: "12:20", special: false},
                    {time: "12:40", special: false},
                    {time: "13:00", special: false},
                    {time: "13:20", special: false},
                    {time: "13:40", special: false},
                    {time: "14:01", special: true},
                    {time: "14:20", special: false},
                    {time: "14:40", special: false},
                    {time: "15:01", special: true},
                    {time: "15:20", special: false},
                    {time: "15:40", special: false},
                    {time: "16:00", special: false},
                    {time: "16:20", special: false},
                    {time: "16:40", special: false},
                    {time: "17:00", special: false},
                    {time: "17:20", special: false},
                    {time: "17:40", special: false},
                    {time: "18:00", special: false},
                    {time: "18:20", special: false},
                    {time: "18:40", special: false},
                    {time: "19:00", special: false},
                    {time: "19:20", special: false},
                    {time: "19:40", special: false},
                    {time: "20:00", special: false},
                    {time: "20:21", special: true},
                    {time: "20:41", special: true},
                    {time: "21:01", special: true},
                    {time: "21:21", special: true},
                    {time: "21:41", special: true},
                    {time: "22:11", special: true},
                    {time: "22:41", special: true}
                ],
                "weekend": [
                    {time: "06:16", special: true},
                    {time: "06:36", special: true},
                    {time: "07:00", special: false},
                    {time: "07:20", special: false},
                    {time: "07:40", special: false},
                    {time: "08:00", special: false},
                    {time: "08:20", special: false},
                    {time: "08:40", special: false},
                    {time: "09:00", special: false},
                    {time: "09:20", special: false},
                    {time: "09:40", special: false},
                    {time: "10:00", special: false},
                    {time: "10:20", special: false},
                    {time: "10:40", special: false},
                    {time: "11:00", special: false},
                    {time: "11:20", special: false},
                    {time: "11:40", special: false},
                    {time: "12:00", special: false},
                    {time: "12:20", special: false},
                    {time: "12:40", special: false},
                    {time: "13:00", special: false},
                    {time: "13:20", special: false},
                    {time: "13:40", special: false},
                    {time: "14:00", special: false},
                    {time: "14:20", special: false},
                    {time: "14:40", special: false},
                    {time: "15:00", special: false},
                    {time: "15:20", special: false},
                    {time: "15:40", special: false},
                    {time: "16:00", special: false},
                    {time: "16:20", special: false},
                    {time: "16:40", special: false},
                    {time: "17:00", special: false},
                    {time: "17:20", special: false},
                    {time: "17:40", special: false},
                    {time: "18:00", special: false},
                    {time: "18:20", special: false},
                    {time: "18:40", special: false},
                    {time: "19:00", special: false},
                    {time: "19:20", special: false},
                    {time: "19:40", special: false},
                    {time: "20:00", special: false},
                    {time: "20:20", special: false},
                    {time: "20:41", special: true},
                    {time: "21:01", special: true},
                    {time: "21:21", special: true},
                    {time: "21:41", special: true},
                    {time: "22:11", special: true},
                    {time: "22:41", special: true}
                ]
            }
        };

        // Public holidays in Hong Kong for 2025
        const publicHolidays = [
            // Standard holidays
            {date: "2025-01-01", name: "New Year's Day", nameZh: "新年"},
            {date: "2025-01-29", name: "Lunar New Year's Day", nameZh: "農曆新年"},
            {date: "2025-01-30", name: "2nd day of Lunar New Year", nameZh: "農曆新年初二"},
            {date: "2025-01-31", name: "3rd day of Lunar New Year", nameZh: "農曆新年初三"},
            {date: "2025-04-04", name: "Ching Ming Festival", nameZh: "清明節"},
            {date: "2025-04-18", name: "Good Friday", nameZh: "耶穌受難節"},
            {date: "2025-04-19", name: "Day after Good Friday", nameZh: "耶穌受難節翌日"},
            {date: "2025-04-21", name: "Easter Monday", nameZh: "復活節星期一"},
            {date: "2025-05-01", name: "Labor Day", nameZh: "勞動節"},
            {date: "2025-05-05", name: "Buddha's Birthday", nameZh: "佛誕"},
            {date: "2025-05-31", name: "Tuen Ng Festival", nameZh: "端午節"},
            {date: "2025-07-01", name: "HKSAR Establishment Day", nameZh: "香港特別行政區成立紀念日"},
            {date: "2025-10-01", name: "National Day", nameZh: "國慶日"},
            {date: "2025-10-07", name: "Day after Mid-Autumn Festival", nameZh: "中秋節翌日"},
            {date: "2025-10-29", name: "Chung Yeung Festival", nameZh: "重陽節"},
            {date: "2025-12-25", name: "Christmas Day", nameZh: "聖誕節"},
            {date: "2025-12-26", name: "Day after Christmas Day", nameZh: "聖誕節翌日"}
        ];

        // Route descriptions for special runs
        const specialRunDescriptions = {
            "en": {
                "ntp-to-vr": "Via Sunshine City",
                "vr-to-ntp": "Via Sunshine City",
                "sc-to-vr": "Via Villa Concerto", 
                "vr-to-sc": "Via Villa Concerto"
            },
            "zh": {
                "ntp-to-vr": "途經新港城",
                "vr-to-ntp": "途經新港城",
                "sc-to-vr": "經凱弦居", 
                "vr-to-sc": "經凱弦居"
            }
        };

        // Day type translations
        const dayTypeText = {
            "en": {
                "weekday": "Weekday",
                "saturday": "Saturday",
                "sunday": "Sunday",
                "holiday": "Public Holiday"
            },
            "zh": {
                "weekday": "平日",
                "saturday": "星期六",
                "sunday": "星期日",
                "holiday": "公眾假期"
            }
        };

        // App state
        let state = {
            currentLang: 'en',
            theme: 'light',
            searchTerm: '',
            lastUpdateTime: 0,
            nextBusCache: {},
            viewMode: 'current'
        };
        
        // Performance optimization: Use requestAnimationFrame for visual updates
        let animationFrameId = null;
        
        // Switch between tabs
        DOM.tabCurrent.addEventListener('click', () => {
            if (state.viewMode !== 'current') {
                DOM.tabCurrent.classList.add('active');
                DOM.tabSchedule.classList.remove('active');
                DOM.currentView.classList.remove('hidden');
                DOM.scheduleView.classList.add('hidden');
                state.viewMode = 'current';
                
                // Update next buses when switching to current view
                updateNextBuses();
            }
        });
        
        DOM.tabSchedule.addEventListener('click', () => {
            if (state.viewMode !== 'schedule') {
                DOM.tabSchedule.classList.add('active');
                DOM.tabCurrent.classList.remove('active');
                DOM.scheduleView.classList.remove('hidden');
                DOM.currentView.classList.add('hidden');
                state.viewMode = 'schedule';
                
                renderSchedule();
            }
        });
        
        // Event listeners for schedule controls
        DOM.routeSelect.addEventListener('change', renderSchedule);
        DOM.daySelect.addEventListener('change', renderSchedule);
        
        // Event listeners for search
        DOM.timeSearch.addEventListener('input', (e) => {
            state.searchTerm = e.target.value.trim();
            renderSchedule();
        });
        
        DOM.clearSearch.addEventListener('click', () => {
            state.searchTerm = '';
            DOM.timeSearch.value = '';
            renderSchedule();
        });
        
        // Language toggle
        DOM.enToggle.addEventListener('click', () => {
            if (state.currentLang !== 'en') {
                state.currentLang = 'en';
                DOM.enToggle.classList.add('active');
                DOM.zhToggle.classList.remove('active');
                updateLanguage();
                updateDatetimeDisplay(); // Update date/time display with new language
            }
        });
        
        DOM.zhToggle.addEventListener('click', () => {
            if (state.currentLang !== 'zh') {
                state.currentLang = 'zh';
                DOM.zhToggle.classList.add('active');
                DOM.enToggle.classList.remove('active');
                updateLanguage();
                updateDatetimeDisplay(); // Update date/time display with new language
            }
        });
        
        // Theme toggle
        DOM.lightToggle.addEventListener('click', () => {
            if (state.theme !== 'light') {
                state.theme = 'light';
                document.documentElement.setAttribute('data-theme', 'light');
                DOM.lightToggle.classList.add('active');
                DOM.darkToggle.classList.remove('active');
            }
        });
        
        DOM.darkToggle.addEventListener('click', () => {
            if (state.theme !== 'dark') {
                state.theme = 'dark';
                document.documentElement.setAttribute('data-theme', 'dark');
                DOM.darkToggle.classList.add('active');
                DOM.lightToggle.classList.remove('active');
            }
        });
        
        // Check for dark mode preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            DOM.darkToggle.click();
        }
        
        // Function to update the language
        function updateLanguage() {
            const elements = document.querySelectorAll('[data-en]');
            elements.forEach(el => {
                el.textContent = el.getAttribute(`data-${state.currentLang}`);
            });
            
            // Update placeholders
            const placeholders = document.querySelectorAll('[data-placeholder-en]');
            placeholders.forEach(el => {
                el.placeholder = el.getAttribute(`data-placeholder-${state.currentLang}`);
            });
            
            // Update the route and day select options
            const routeOptions = DOM.routeSelect.querySelectorAll('option');
            routeOptions.forEach(option => {
                option.textContent = option.getAttribute(`data-${state.currentLang}`);
            });
            
            const dayOptions = DOM.daySelect.querySelectorAll('option');
            dayOptions.forEach(option => {
                option.textContent = option.getAttribute(`data-${state.currentLang}`);
            });
            
            // Update the special notices
            updateNextBuses();
            
            // Update the schedule title if in schedule view
            if (state.viewMode === 'schedule') {
                renderSchedule();
            }
            
            // Update day type display
            updateDayTypeDisplay();
        }
        
        // Function to format date based on language
        function formatDate(date, lang) {
            if (lang === 'en') {
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                return date.toLocaleDateString('en-US', options);
            } else {
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const weekday = ['日', '一', '二', '三', '四', '五', '六'][date.getDay()];
                
                return `${year}年${month}月${day}日 星期${weekday}`;
            }
        }
        
        // Function to check if a date is a public holiday and get its name
        function getHolidayInfo(date) {
            const dateString = date.toISOString().slice(0, 10); // Format as YYYY-MM-DD
            const holiday = publicHolidays.find(h => h.date === dateString);
            
            if (holiday) {
                return {
                    isHoliday: true,
                    name: state.currentLang === 'en' ? holiday.name : holiday.nameZh
                };
            }
            
            return { isHoliday: false, name: '' };
        }
        
        // Function to update the date and time display (fixed to update every second)
        function updateDatetimeDisplay() {
            const now = new Date();
            
            // Update date
            DOM.currentDate.textContent = formatDate(now, state.currentLang);
            
            // Update time - this now properly updates seconds
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            
            DOM.hoursEl.textContent = hours;
            DOM.minutesEl.textContent = minutes;
            DOM.secondsEl.textContent = seconds;
            
            // Update day type
            updateDayTypeDisplay();
        }
        
        // Function to update the day type display
        function updateDayTypeDisplay() {
            const now = new Date();
            const dayType = getDayType();
            
            // Update the text
            DOM.dayType.textContent = dayTypeText[state.currentLang][dayType];
            
            // Update the class
            DOM.dayType.className = 'day-type-display';
            if (dayType === 'saturday') {
                DOM.dayType.classList.add('weekend');
            } else if (dayType === 'sunday' || dayType === 'holiday') {
                DOM.dayType.classList.add('holiday');
            }
            
            // Show holiday name if applicable
            const holidayInfo = getHolidayInfo(now);
            if (holidayInfo.isHoliday) {
                DOM.holidayName.textContent = holidayInfo.name;
                DOM.holidayName.classList.remove('hidden');
            } else {
                DOM.holidayName.classList.add('hidden');
            }
        }
        
        // Function to get the day type (weekday, saturday, sunday, or holiday)
        function getDayType() {
            const now = new Date();
            const day = now.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
            
            const holidayInfo = getHolidayInfo(now);
            if (holidayInfo.isHoliday) {
                return 'holiday';
            }
            
            if (day === 0) {
                return 'sunday';
            } else if (day === 6) {
                return 'saturday';
            } else {
                return 'weekday';
            }
        }
        
        // Function to check if it's a weekday schedule or weekend/holiday schedule
        function isWeekdaySchedule() {
            const dayType = getDayType();
            return dayType === 'weekday'; // Only return true for regular weekdays
        }
        
        // Helper function to convert time string to minutes
        function timeToMinutes(timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            return hours * 60 + minutes;
        }
        
        // Function to get both next and previous buses
        function getBusTimings(routeKey) {
            const now = new Date();
            const dayType = isWeekdaySchedule() ? "weekday" : "weekend";
            const schedule = busSchedules[routeKey][dayType];
            
            const currentHours = now.getHours();
            const currentMinutes = now.getMinutes();
            const currentSeconds = now.getSeconds();  // Include seconds for more precise calculations
            const currentTimeInMinutes = currentHours * 60 + currentMinutes + (currentSeconds / 60);
            
            let nextBusIndex = -1;
            let prevBusIndex = -1;
            
            // Find the next bus
            for (let i = 0; i < schedule.length; i++) {
                const busTimeInMinutes = timeToMinutes(schedule[i].time);
                
                if (busTimeInMinutes > currentTimeInMinutes) {
                    nextBusIndex = i;
                    prevBusIndex = i > 0 ? i - 1 : schedule.length - 1; // Previous bus or last bus from yesterday
                    break;
                }
            }
            
            // If no next bus found today, it's the first bus tomorrow
            if (nextBusIndex === -1) {
                nextBusIndex = 0; // First bus tomorrow
                prevBusIndex = schedule.length - 1; // Last bus today
            }
            
            const nextBus = schedule[nextBusIndex];
            const prevBus = schedule[prevBusIndex];
            
            // Calculate time until next bus
            const nextBusTimeInMinutes = timeToMinutes(nextBus.time);
            let minutesUntil;
            let isTomorrow = false;
            
            if (nextBusTimeInMinutes > currentTimeInMinutes) {
                // Next bus is later today
                minutesUntil = nextBusTimeInMinutes - currentTimeInMinutes;
            } else {
                // Next bus is tomorrow
                minutesUntil = (24 * 60 - currentTimeInMinutes) + nextBusTimeInMinutes;
                isTomorrow = true;
            }
            
            // Calculate progress between buses
            const prevBusTimeInMinutes = timeToMinutes(prevBus.time);
            let totalInterval;
            let elapsed;
            
            if (prevBusTimeInMinutes < nextBusTimeInMinutes && !isTomorrow) {
                // Normal case: prev bus was earlier today, next bus is later today
                totalInterval = nextBusTimeInMinutes - prevBusTimeInMinutes;
                elapsed = currentTimeInMinutes - prevBusTimeInMinutes;
            } else if (isTomorrow) {
                // Next bus is tomorrow
                totalInterval = (24 * 60 - prevBusTimeInMinutes) + nextBusTimeInMinutes;
                elapsed = currentTimeInMinutes - prevBusTimeInMinutes;
                if (elapsed < 0) {
                    // If elapsed is negative, previous bus was yesterday
                    elapsed += 24 * 60;
                }
            } else {
                // Previous bus was yesterday (unlikely case)
                totalInterval = nextBusTimeInMinutes + (24 * 60 - prevBusTimeInMinutes);
                elapsed = currentTimeInMinutes + (24 * 60 - prevBusTimeInMinutes);
            }
            
            // Ensure progress is between 0 and 100%
            const progressPercent = Math.min(100, Math.max(0, (elapsed / totalInterval) * 100));
            
            return {
                next: nextBus,
                prev: prevBus,
                minutesUntil: minutesUntil,
                progressPercent: progressPercent,
                tomorrow: isTomorrow
            };
        }
        
        // Function to format minutes into hours and minutes
        function formatMinutes(minutes) {
            const totalMinutes = Math.floor(minutes);
            const seconds = Math.floor((minutes - totalMinutes) * 60);
            
            if (totalMinutes < 60) {
                return `${totalMinutes} min ${seconds} sec`;
            } else {
                const hours = Math.floor(totalMinutes / 60);
                const mins = totalMinutes % 60;
                return `${hours} hr ${mins} min ${seconds} sec`;
            }
        }
        
        // Function to update a single next bus display with accurate progress bar
        function updateNextBusDisplay(routeKey, elements, specialDescriptions) {
            const busTimings = getBusTimings(routeKey);
            const nextBus = busTimings.next;
            
            // Update the time
            elements.time.textContent = nextBus.time;
            if (nextBus.special) {
                elements.time.classList.add('special');
                elements.notice.textContent = state.currentLang === 'en' ? 
                    "Special Run - " + specialDescriptions.en[routeKey] :
                    "特別班次 - " + specialDescriptions.zh[routeKey];
            } else {
                elements.time.classList.remove('special');
                elements.notice.textContent = "";
            }
            
            // Update the countdown text
            const countdownText = busTimings.tomorrow 
                ? (state.currentLang === 'en' ? 
                   `Arriving tomorrow in ${formatMinutes(busTimings.minutesUntil)}` :
                   `明天到達，還剩 ${formatMinutes(busTimings.minutesUntil)}`)
                : (state.currentLang === 'en' ? 
                   `Arriving in ${formatMinutes(busTimings.minutesUntil)}` :
                   `到達時間剩餘 ${formatMinutes(busTimings.minutesUntil)}`);
            elements.countdown.textContent = countdownText;
            
            // Update the progress bar - now accurately representing progress between buses
            elements.progress.style.width = busTimings.progressPercent + '%';
            
            return nextBus;
        }
        
        // Function to update all next bus information
        function updateNextBuses() {
            // Make this less restrictive - it now updates every second
            const now = Date.now();
            state.lastUpdateTime = now;
            
            if (state.viewMode !== 'current') {
                return; // Don't update when not in the current view
            }
            
            // Update each route
            updateNextBusDisplay('ntp-to-vr', DOM.nextNTPtoVR, specialRunDescriptions);
            updateNextBusDisplay('vr-to-ntp', DOM.nextVRtoNTP, specialRunDescriptions);
            updateNextBusDisplay('sc-to-vr', DOM.nextSCtoVR, specialRunDescriptions);
            updateNextBusDisplay('vr-to-sc', DOM.nextVRtoSC, specialRunDescriptions);
        }
        
        // Function to filter times based on search
        function filterTimes(times, searchTerm) {
            if (!searchTerm) return times;
            
            return times.filter(bus => {
                return bus.time.includes(searchTerm);
            });
        }
        
        // Function to render the schedule
        function renderSchedule() {
            if (state.viewMode !== 'schedule') {
                return; // Don't render when not in schedule view
            }
            
            const routeKey = DOM.routeSelect.value;
            const dayType = DOM.daySelect.value;
            const schedule = busSchedules[routeKey][dayType];
            
            // Update the title based on the selected route
            let titleText = DOM.routeSelect.options[DOM.routeSelect.selectedIndex].textContent;
            DOM.scheduleTitle.textContent = titleText;
            
            // Filter based on search term
            const filteredSchedule = filterTimes(schedule, state.searchTerm);
            
            // Clear the grid
            DOM.timeGrid.innerHTML = '';
            
            // Get the next bus for highlighting
            const now = new Date();
            const currentDayType = isWeekdaySchedule() ? "weekday" : "weekend";
            let nextBusTime = null;
            
            if (currentDayType === dayType) {
                const busTimings = getBusTimings(routeKey);
                nextBusTime = busTimings.next.time;
            }
            
            // Create a document fragment for better performance
            const fragment = document.createDocumentFragment();
            
            // Add each time to the grid
            filteredSchedule.forEach(bus => {
                const timeCell = document.createElement('div');
                timeCell.textContent = bus.time;
                timeCell.classList.add('time-cell');
                
                if (bus.special) {
                    timeCell.classList.add('special');
                }
                
                if (bus.time === nextBusTime && currentDayType === dayType) {
                    timeCell.classList.add('next');
                }
                
                // Highlight search results
                if (state.searchTerm && bus.time.includes(state.searchTerm)) {
                    timeCell.classList.add('highlight');
                }
                
                fragment.appendChild(timeCell);
            });
            
            // Append all at once for better performance
            DOM.timeGrid.appendChild(fragment);
        }
        
        // Function to update UI elements periodically
        function updateUI() {
            // Cancel any existing animation frame
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            
            updateDatetimeDisplay();
            updateNextBuses();
            
            // If in schedule view, update the highlighted next bus 
            // only occasionally for performance reasons
            if (state.viewMode === 'schedule' && Math.random() < 0.1) {  // 10% chance to update
                renderSchedule();
            }
            
            // Schedule the next update
            animationFrameId = requestAnimationFrame(() => {
                setTimeout(updateUI, 1000);
            });
        }
        
        // Function to save user preferences
        function savePreferences() {
            try {
                localStorage.setItem('busSchedulePrefs', JSON.stringify({
                    language: state.currentLang,
                    theme: state.theme
                }));
            } catch (e) {
                console.log('Could not save preferences:', e);
            }
        }
        
        // Function to load user preferences
        function loadPreferences() {
            try {
                const prefs = JSON.parse(localStorage.getItem('busSchedulePrefs'));
                if (prefs) {
                    // Apply language
                    if (prefs.language === 'zh') {
                        DOM.zhToggle.click();
                    } else {
                        DOM.enToggle.click();
                    }
                    
                    // Apply theme
                    if (prefs.theme === 'dark') {
                        DOM.darkToggle.click();
                    } else {
                        DOM.lightToggle.click();
                    }
                }
            } catch (e) {
                console.log('Could not load preferences:', e);
            }
        }
        
        // Initialize the app
        function init() {
            // Load user preferences
            loadPreferences();
            
            // Initial UI update
            updateUI();
            
            // Set the day select to current day type
            DOM.daySelect.value = isWeekdaySchedule() ? "weekday" : "weekend";
            
            // Initialize with the current view
            DOM.tabCurrent.click();
            
            // Save preferences on unload
            window.addEventListener('beforeunload', savePreferences);
        }
        
        // Start the app
        init();
    </script>
</body>
</html>
